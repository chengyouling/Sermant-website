<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Graceful Online/Offline | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh based on Bytecode Enhancement">
    
    <link rel="preload" href="/assets/css/0.styles.b3162cc2.css" as="style"><link rel="preload" href="/assets/js/app.c34464d8.js" as="script"><link rel="preload" href="/assets/js/3.5623409f.js" as="script"><link rel="preload" href="/assets/js/1.b15421ba.js" as="script"><link rel="preload" href="/assets/js/49.542faebd.js" as="script"><link rel="preload" href="/assets/js/15.e73a6d7c.js" as="script"><link rel="prefetch" href="/assets/js/10.cfbef995.js"><link rel="prefetch" href="/assets/js/100.3d6a9739.js"><link rel="prefetch" href="/assets/js/101.3eedcd7b.js"><link rel="prefetch" href="/assets/js/102.84170d48.js"><link rel="prefetch" href="/assets/js/103.44757c80.js"><link rel="prefetch" href="/assets/js/104.442505cf.js"><link rel="prefetch" href="/assets/js/105.ee4514a0.js"><link rel="prefetch" href="/assets/js/106.96348ffa.js"><link rel="prefetch" href="/assets/js/107.354006b4.js"><link rel="prefetch" href="/assets/js/108.9bc40e5d.js"><link rel="prefetch" href="/assets/js/109.29f344ad.js"><link rel="prefetch" href="/assets/js/11.60305907.js"><link rel="prefetch" href="/assets/js/110.f9e9ad38.js"><link rel="prefetch" href="/assets/js/111.6425ee2b.js"><link rel="prefetch" href="/assets/js/112.214fe313.js"><link rel="prefetch" href="/assets/js/113.3fda965f.js"><link rel="prefetch" href="/assets/js/114.cd06da03.js"><link rel="prefetch" href="/assets/js/12.34d38cf9.js"><link rel="prefetch" href="/assets/js/13.5dac980d.js"><link rel="prefetch" href="/assets/js/14.970216ca.js"><link rel="prefetch" href="/assets/js/16.fec41699.js"><link rel="prefetch" href="/assets/js/17.f476faab.js"><link rel="prefetch" href="/assets/js/18.f406bc1c.js"><link rel="prefetch" href="/assets/js/19.a75ad99f.js"><link rel="prefetch" href="/assets/js/20.b657f769.js"><link rel="prefetch" href="/assets/js/21.a73549a1.js"><link rel="prefetch" href="/assets/js/22.90975c19.js"><link rel="prefetch" href="/assets/js/23.97cb668f.js"><link rel="prefetch" href="/assets/js/24.c2865696.js"><link rel="prefetch" href="/assets/js/25.ece41e63.js"><link rel="prefetch" href="/assets/js/26.7b323e16.js"><link rel="prefetch" href="/assets/js/27.6dcf2105.js"><link rel="prefetch" href="/assets/js/28.44ffc507.js"><link rel="prefetch" href="/assets/js/29.00d72429.js"><link rel="prefetch" href="/assets/js/30.a9bda1a3.js"><link rel="prefetch" href="/assets/js/31.94f98f6a.js"><link rel="prefetch" href="/assets/js/32.9179c939.js"><link rel="prefetch" href="/assets/js/33.40565414.js"><link rel="prefetch" href="/assets/js/34.f35ece3c.js"><link rel="prefetch" href="/assets/js/35.7997bb73.js"><link rel="prefetch" href="/assets/js/36.d0e88faf.js"><link rel="prefetch" href="/assets/js/37.65297502.js"><link rel="prefetch" href="/assets/js/38.bce7ab73.js"><link rel="prefetch" href="/assets/js/39.d188ac53.js"><link rel="prefetch" href="/assets/js/4.1f7cf31c.js"><link rel="prefetch" href="/assets/js/40.78ec2e67.js"><link rel="prefetch" href="/assets/js/41.e3b351a9.js"><link rel="prefetch" href="/assets/js/42.aa7440af.js"><link rel="prefetch" href="/assets/js/43.22c3a611.js"><link rel="prefetch" href="/assets/js/44.5c836176.js"><link rel="prefetch" href="/assets/js/45.ffae3103.js"><link rel="prefetch" href="/assets/js/46.029e7a53.js"><link rel="prefetch" href="/assets/js/47.e3c0e87b.js"><link rel="prefetch" href="/assets/js/48.e2216aa1.js"><link rel="prefetch" href="/assets/js/5.27b946c4.js"><link rel="prefetch" href="/assets/js/50.5984ebe8.js"><link rel="prefetch" href="/assets/js/51.84bed0df.js"><link rel="prefetch" href="/assets/js/52.cd80e161.js"><link rel="prefetch" href="/assets/js/53.6105c07a.js"><link rel="prefetch" href="/assets/js/54.7551e07a.js"><link rel="prefetch" href="/assets/js/55.e4dd9c00.js"><link rel="prefetch" href="/assets/js/56.cf7116d4.js"><link rel="prefetch" href="/assets/js/57.24abb40c.js"><link rel="prefetch" href="/assets/js/58.a1110b96.js"><link rel="prefetch" href="/assets/js/59.f2ac3049.js"><link rel="prefetch" href="/assets/js/6.a6913bc1.js"><link rel="prefetch" href="/assets/js/60.c755a675.js"><link rel="prefetch" href="/assets/js/61.c51a6afc.js"><link rel="prefetch" href="/assets/js/62.bf496ef7.js"><link rel="prefetch" href="/assets/js/63.00bda3cb.js"><link rel="prefetch" href="/assets/js/64.5c87a987.js"><link rel="prefetch" href="/assets/js/65.43e53669.js"><link rel="prefetch" href="/assets/js/66.01ab662c.js"><link rel="prefetch" href="/assets/js/67.12af2e0d.js"><link rel="prefetch" href="/assets/js/68.f23d7700.js"><link rel="prefetch" href="/assets/js/69.db808a64.js"><link rel="prefetch" href="/assets/js/7.d018164a.js"><link rel="prefetch" href="/assets/js/70.ae68765e.js"><link rel="prefetch" href="/assets/js/71.0dfbb3ed.js"><link rel="prefetch" href="/assets/js/72.97482199.js"><link rel="prefetch" href="/assets/js/73.f61e374c.js"><link rel="prefetch" href="/assets/js/74.f03337eb.js"><link rel="prefetch" href="/assets/js/75.202cac83.js"><link rel="prefetch" href="/assets/js/76.f016936f.js"><link rel="prefetch" href="/assets/js/77.e85e9764.js"><link rel="prefetch" href="/assets/js/78.80df963f.js"><link rel="prefetch" href="/assets/js/79.f61d5657.js"><link rel="prefetch" href="/assets/js/8.10750ce9.js"><link rel="prefetch" href="/assets/js/80.44892390.js"><link rel="prefetch" href="/assets/js/81.3d4d9fb6.js"><link rel="prefetch" href="/assets/js/82.c0f32a13.js"><link rel="prefetch" href="/assets/js/83.03ec3fb3.js"><link rel="prefetch" href="/assets/js/84.69720cbc.js"><link rel="prefetch" href="/assets/js/85.db79c6f2.js"><link rel="prefetch" href="/assets/js/86.60956aad.js"><link rel="prefetch" href="/assets/js/87.d0423727.js"><link rel="prefetch" href="/assets/js/88.f605a832.js"><link rel="prefetch" href="/assets/js/89.555b5dd8.js"><link rel="prefetch" href="/assets/js/9.4d2ce84a.js"><link rel="prefetch" href="/assets/js/90.7f55c5a5.js"><link rel="prefetch" href="/assets/js/91.7f3d434f.js"><link rel="prefetch" href="/assets/js/92.fa4e44ac.js"><link rel="prefetch" href="/assets/js/93.d6ef1485.js"><link rel="prefetch" href="/assets/js/94.45889e9d.js"><link rel="prefetch" href="/assets/js/95.44640acb.js"><link rel="prefetch" href="/assets/js/96.52f11b89.js"><link rel="prefetch" href="/assets/js/97.879cc35a.js"><link rel="prefetch" href="/assets/js/98.5353c6f2.js"><link rel="prefetch" href="/assets/js/99.714a3883.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b3162cc2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/en/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/sermant-io/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/graceful.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/graceful.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/sermant-io/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/graceful.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/graceful.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Plugin Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/en/document/plugin/" aria-current="page" class="sidebar-link">Plugin</a></li><li><a href="/en/document/plugin/dynamic-config.html" class="sidebar-link">Dynamic Configuration</a></li><li><a href="/en/document/plugin/springboot-registry.html" class="sidebar-link">SpringBoot Registry</a></li><li><a href="/en/document/plugin/register-migration.html" class="sidebar-link">Service-Registry</a></li><li><a href="/en/document/plugin/flowcontrol.html" class="sidebar-link">FlowControl</a></li><li><a href="/en/document/plugin/graceful.html" aria-current="page" class="active sidebar-link">Graceful Online/Offline</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/en/document/plugin/graceful.html#functions" class="sidebar-link">Functions</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/graceful.html#supported-versions-and-limitations" class="sidebar-link">Supported Versions and Limitations</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/graceful.html#parameter-configuration" class="sidebar-link">Parameter configuration</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/graceful.html#supported-versions-and-limitations-2" class="sidebar-link">Supported Versions and Limitations</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/graceful.html#operation-and-result-validation" class="sidebar-link">Operation and result validation</a></li></ul></li><li><a href="/en/document/plugin/removal.html" class="sidebar-link">Outlier instance removal</a></li><li><a href="/en/document/plugin/loadbalancer.html" class="sidebar-link">Load balancing</a></li><li><a href="/en/document/plugin/router.html" class="sidebar-link">Tag Router</a></li><li><a href="/en/document/plugin/monitor.html" class="sidebar-link">Monitoring</a></li><li><a href="/en/document/plugin/visibility.html" class="sidebar-link">Service visibility</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developer Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="graceful-online-offline"><a href="#graceful-online-offline" class="header-anchor">#</a> Graceful Online/Offline</h1> <p>This article introduces how to use the graceful log-in and log-in plugin. Currently, the elegant log-in and log-out function is currently integrated in the <a href="https://github.com/sermant-io/Sermant/tree/develop/sermant-plugins/sermant-service-registry" target="_blank" rel="noopener noreferrer">registration plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, Can be used independently.</p> <h2 id="functions"><a href="#functions" class="header-anchor">#</a> Functions</h2> <p>For any online application, operations such as release, expansion, reduction, and restart are unavoidable, and the following problems are often encountered in the process:</p> <ul><li>For a newly launched instance, due to excessive traffic, the instance is accessed by a large amount of traffic when it is initialized, resulting in request blocking or even downtime, such as lazy loading scenarios.</li> <li>When the instance goes offline, due to the delayed refresh problem found in the registration, the upstream cannot be notified in time, resulting in traffic loss or errors.</li></ul> <p>In order to solve the above problems, graceful log-off came into being. For the above two problems, the plug-in provides <strong>preheating</strong> and <strong>graceful log-off</strong> capabilities to provide protection for the above-mentioned scenario problems.</p> <p><strong>Warm up</strong>, as the name suggests, uses a small amount of traffic to access the instance first, and gradually increases the traffic based on time to ensure that the newly started instance can successfully transition.</p> <p><strong>Graceful offline</strong>,  The plugin quickly updates the upstream cache based on the <strong>real-time notification</strong> + <strong>cache update mechanism</strong>. In addition, traffic statistics are collected to ensure that the instances that are about to go offline can process traffic as much as possible, preventing traffic loss to the greatest extent.</p> <h2 id="supported-versions-and-limitations"><a href="#supported-versions-and-limitations" class="header-anchor">#</a> Supported Versions and Limitations</h2> <p>Currently, the graceful online/offline capability <strong>supports only SpringCloud applications</strong>. Ensure that the SpringCloud version is <code>Edgware.SR2</code> or later.</p> <p>Regitry Center Support：Zookeeper、Consul、Nacos、Eureka、Service Center</p> <p><strong>Notice</strong>：The graceful online/offline capability is developed based on the default load balancing capability of SpringCloud. If you have implemented the custom load balancing capability, this capability is no longer applicable.</p> <h2 id="parameter-configuration"><a href="#parameter-configuration" class="header-anchor">#</a> Parameter configuration</h2> <h3 id="enabling-graceful-online-and-offline"><a href="#enabling-graceful-online-and-offline" class="header-anchor">#</a> Enabling Graceful Online and Offline</h3> <p>The graceful log-in plug-in needs to enable the graceful log-in switch (<code>grace.rule.enableSpring</code>), configure the startup delay time (<code>grace.rule.startDelayTime</code>), enable the warm-up (<code>grace.rule.enableWarmUp</code>), and other configurations. Find the configuration file of the plugin in <code>${path}/sermant-agent-x.x.x/agent/pluginPackge/service-registry/config/config.yaml</code>, the configuration is as follows:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">grace.rule</span><span class="token punctuation">:</span>
  <span class="token key atrule">enableSpring</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># SpringCloud graceful online/offline switch</span>
  <span class="token key atrule">startDelayTime</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token comment"># Graceful online/offline start delay, unit is seconds</span>
  <span class="token key atrule">enableWarmUp</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># Whether to enable warm up</span>
  <span class="token key atrule">warmUpTime</span><span class="token punctuation">:</span> <span class="token number">120</span>    <span class="token comment"># Warm up time unit is seconds</span>
  <span class="token key atrule">enableGraceShutdown</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># Whether to enable graceful offline</span>
  <span class="token key atrule">shutdownWaitTime</span><span class="token punctuation">:</span> <span class="token number">30</span>  <span class="token comment"># The maximum waiting time before traffic detection is disabled. Unit: s. This parameter takes effect only after enabledGraceShutdown is enabled.</span>
  <span class="token key atrule">enableOfflineNotify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># Whether to enable proactive offline notification.</span>
  <span class="token key atrule">httpServerPort</span><span class="token punctuation">:</span> <span class="token number">16688</span> <span class="token comment"># Enable the http server port for proactive offline notification.</span>
  <span class="token key atrule">upstreamAddressMaxSize</span><span class="token punctuation">:</span> <span class="token number">500</span> <span class="token comment"># Default size of the cache upstream address</span>
  <span class="token key atrule">upstreamAddressExpiredTime</span><span class="token punctuation">:</span> <span class="token number">60</span> <span class="token comment"># Expiration time of the cached upstream address. Unit: s.</span>
</code></pre></div><table><thead><tr><th style="text-align:left;">Parameter key</th> <th style="text-align:left;">Description</th> <th style="text-align:left;">Default value</th> <th style="text-align:left;">Required</th></tr></thead> <tbody><tr><td style="text-align:left;">grace.rule.enableSpring</td> <td style="text-align:left;">springCloud elegant online and offline switch</td> <td style="text-align:left;">false</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.startDelayTime</td> <td style="text-align:left;">Graceful online and offline startup delay time, unit S</td> <td style="text-align:left;">0</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.enableWarmUp</td> <td style="text-align:left;">Whether to enable preheating</td> <td style="text-align:left;">false</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.enableGraceShutdown</td> <td style="text-align:left;">Whether to enable graceful offline</td> <td style="text-align:left;">false</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.shutdownWaitTime</td> <td style="text-align:left;">The maximum waiting time for related traffic detection before shutdown, unit S. EnabledGraceShutdown needs to be enabled to take effect</td> <td style="text-align:left;">30</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.enableOfflineNotify</td> <td style="text-align:left;">Whether to open the offline active notification</td> <td style="text-align:left;">false</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.httpServerPort</td> <td style="text-align:left;">The httpServer port for active offline notification is enabled</td> <td style="text-align:left;">16688</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.upstreamAddressMaxSize</td> <td style="text-align:left;">The default size of cached upstream addresses</td> <td style="text-align:left;">5000</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">grace.rule.upstreamAddressExpiredTime</td> <td style="text-align:left;">Expiration time of cache upstream address, unit S</td> <td style="text-align:left;">60</td> <td style="text-align:left;">YES</td></tr></tbody></table> <h2 id="supported-versions-and-limitations-2"><a href="#supported-versions-and-limitations-2" class="header-anchor">#</a> Supported Versions and Limitations</h2> <p>Framework support:</p> <ul><li><strong>Only supports SpringCloud applications</strong>, you need to ensure that the SpringCloud version is <code>Edgware.SR2</code> and above</li> <li>Registry support: Zookeeper, Consul, Nacos, Eureka, ServiceCenter</li></ul> <p>Limit:</p> <ul><li>The ability to go online and offline gracefully is developed based on SpringCloud's default load balancing capability. If you implement a custom load balancing capability, this capability will no longer apply</li></ul> <h2 id="operation-and-result-validation"><a href="#operation-and-result-validation" class="header-anchor">#</a> Operation and result validation</h2> <p>The following demonstrates how to use the graceful online and offline plugin.</p> <h3 id="preparation"><a href="#preparation" class="header-anchor">#</a> Preparation</h3> <ul><li><a href="https://github.com/sermant-io/Sermant/releases" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>/Compile the sermant package</li> <li><a href="https://github.com/sermant-io/Sermant-examples/tree/main/grace-demo/spring-grace-nacos-demo" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Demo source code</li> <li><a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> nacos, and start</li> <li><a href="https://zookeeper.apache.org/releases.html#download" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> zookeeper, and start</li></ul> <h3 id="step-1-compile-and-package-the-demo-application"><a href="#step-1-compile-and-package-the-demo-application" class="header-anchor">#</a> Step 1: Compile and package the demo application</h3> <p>Execute the following command in the <code>${path}/Sermant-examples/grace-demo/spring-grace-nacos-demo</code> directory:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mvn clean package
</code></pre></div><p>After successful packaging, you can get <code>nacos-rest-data-2.2.0.RELEASE.jar in</code>${path}/Sermant-examples/grace-demo/spring-grace-nacos-demo/nacos-rest-data/target<code></code>package, get <code>nacos-rest-consumer-2.2.0.RELEASE.jar</code> at <code>${path}/Sermant-examples/grace-demo/spring-grace-nacos-demo/nacos-rest-consumer/target</code> , get <code>nacos-rest-provider-2.2.0.RELEASE.jar</code> in <code>${path}/Sermant-examples/grace-demo/spring-grace-nacos-demo/nacos-rest-provider/target</code>.</p> <blockquote><p>Note: path is the path where the demo application is downloaded.</p></blockquote> <h3 id="step-2-deploy-the-application"><a href="#step-2-deploy-the-application" class="header-anchor">#</a> Step 2: Deploy the application</h3> <p>We will deploy a consumer instance, 2 provider instances, and a data instance. as follows:</p> <p><code>consumer -----------&gt; provider (two instances) -------------&gt; data</code></p> <p>Among them, the consumer enables the graceful log-off capability, one provider instance enables the warm-up and graceful log-off capabilities, and the other provider instance only enables the graceful log-off capability.</p> <blockquote><p>Note: The parameters of the graceful log-in and log-out plug-in are configured below through the -D parameter when the application starts.</p></blockquote> <p>(1) start data</p> <div class="language-shell extra-class"><pre class="language-shell"><code>   <span class="token function">java</span> -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-jar</span> nacos-rest-data-2.2.0.RELEASE.jar
</code></pre></div><p>(2) Start the first provider instance (port 8880, <strong>Turn off preheating function</strong>)</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Run under Linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dgrace.rule.enableSpring</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableWarmUp</span><span class="token operator">=</span>false <span class="token parameter variable">-Dgrace.rule.enableGraceShutdown</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableOfflineNotify</span><span class="token operator">=</span>true -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8880</span> -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> nacos-rest-provider-2.2.0.RELEASE.jar
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Run under Windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dgrace.rule.enableSpring</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableWarmUp</span><span class="token operator">=</span>false <span class="token parameter variable">-Dgrace.rule.enableGraceShutdown</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableOfflineNotify</span><span class="token operator">=</span>true -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8880</span> -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> nacos-rest-provider-2.2.0.RELEASE.jar
</code></pre></div><p>(3) Start the second provider instance (port 8890, <strong>enable preheating capability</strong>)</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Run under Linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dgrace.rule.enableSpring</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableWarmUp</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableGraceShutdown</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableOfflineNotify</span><span class="token operator">=</span>true -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8890</span> -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> nacos-rest-provider-2.2.0.RELEASE.jar
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Run under Windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dgrace.rule.enableSpring</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableWarmUp</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableGraceShutdown</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableOfflineNotify</span><span class="token operator">=</span>true -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8890</span> -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> nacos-rest-provider-2.2.0.RELEASE.jar
</code></pre></div><p>(4) start consumer</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Run under Linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dgrace.rule.enableSpring</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableWarmUp</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableGraceShutdown</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableOfflineNotify</span><span class="token operator">=</span>true -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8800</span> -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> nacos-rest-consumer-2.2.0.RELEASE.jar
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Run under Windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dgrace.rule.enableSpring</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableWarmUp</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableGraceShutdown</span><span class="token operator">=</span>true <span class="token parameter variable">-Dgrace.rule.enableOfflineNotify</span><span class="token operator">=</span>true -Dspring.cloud.nacos.discovery.server-addr<span class="token operator">=</span>localhost:8848 <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8800</span> -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> nacos-rest-consumer-2.2.0.RELEASE.jar
</code></pre></div><blockquote><p><strong>Description</strong>:
where path needs to be replaced with the actual installation path of Sermant.
x.x.x represents a Sermant version number.</p></blockquote> <h3 id="verification"><a href="#verification" class="header-anchor">#</a> Verification</h3> <h4 id="preheating-capability-verification"><a href="#preheating-capability-verification" class="header-anchor">#</a> Preheating capability verification</h4> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <p>Access the interface <code>localhost:8800/graceHot</code>, and judge whether the preheating is effective according to the ip and port returned by the interface. If during the warm-up period (default 120s) the access is biased towards the provider whose port is <code>8880</code>, and the traffic becomes <strong>average</strong> over time, it means that the pre-heating takes effect.</p> <h4 id="elegant-offline-verification"><a href="#elegant-offline-verification" class="header-anchor">#</a> Elegant offline verification</h4> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <p>Continue to access the interface <code>localhost:8800/graceDownOpen</code>, and then log off one of the provider instances to observe whether there is an error in the request. If there is no error, the graceful offline capability verification is successful.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/10/2024, 2:13:27 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/en/document/plugin/flowcontrol.html" class="prev">
        FlowControl
      </a></span> <span class="next"><a href="/en/document/plugin/removal.html">
        Outlier instance removal
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c34464d8.js" defer></script><script src="/assets/js/3.5623409f.js" defer></script><script src="/assets/js/1.b15421ba.js" defer></script><script src="/assets/js/49.542faebd.js" defer></script><script src="/assets/js/15.e73a6d7c.js" defer></script>
  </body>
</html>
