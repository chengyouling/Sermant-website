<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Link Function | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh Solution Based on JavaAgent">
    
    <link rel="preload" href="/assets/css/0.styles.a72ad1e6.css" as="style"><link rel="preload" href="/assets/js/app.5ad3fa69.js" as="script"><link rel="preload" href="/assets/js/3.0215ffee.js" as="script"><link rel="preload" href="/assets/js/1.b15421ba.js" as="script"><link rel="preload" href="/assets/js/37.f21874a8.js" as="script"><link rel="preload" href="/assets/js/15.e73a6d7c.js" as="script"><link rel="prefetch" href="/assets/js/10.3bbc2b94.js"><link rel="prefetch" href="/assets/js/100.fa2e5115.js"><link rel="prefetch" href="/assets/js/101.4fec3f16.js"><link rel="prefetch" href="/assets/js/11.60305907.js"><link rel="prefetch" href="/assets/js/12.34d38cf9.js"><link rel="prefetch" href="/assets/js/13.3451d8aa.js"><link rel="prefetch" href="/assets/js/14.5ec66318.js"><link rel="prefetch" href="/assets/js/16.fec41699.js"><link rel="prefetch" href="/assets/js/17.90db0ca5.js"><link rel="prefetch" href="/assets/js/18.af63b629.js"><link rel="prefetch" href="/assets/js/19.e8dc807a.js"><link rel="prefetch" href="/assets/js/20.9c202bf3.js"><link rel="prefetch" href="/assets/js/21.cf0e056b.js"><link rel="prefetch" href="/assets/js/22.c5baa208.js"><link rel="prefetch" href="/assets/js/23.992d6ecf.js"><link rel="prefetch" href="/assets/js/24.f54681b4.js"><link rel="prefetch" href="/assets/js/25.8b4cd8a3.js"><link rel="prefetch" href="/assets/js/26.72bf5c4f.js"><link rel="prefetch" href="/assets/js/27.0365e804.js"><link rel="prefetch" href="/assets/js/28.c56e814f.js"><link rel="prefetch" href="/assets/js/29.508fe576.js"><link rel="prefetch" href="/assets/js/30.2e8b6a38.js"><link rel="prefetch" href="/assets/js/31.55eaa738.js"><link rel="prefetch" href="/assets/js/32.bbc3c1da.js"><link rel="prefetch" href="/assets/js/33.6168213a.js"><link rel="prefetch" href="/assets/js/34.e383d362.js"><link rel="prefetch" href="/assets/js/35.7f2be29c.js"><link rel="prefetch" href="/assets/js/36.87f18852.js"><link rel="prefetch" href="/assets/js/38.77a834ea.js"><link rel="prefetch" href="/assets/js/39.e9321c9a.js"><link rel="prefetch" href="/assets/js/4.b5e11e65.js"><link rel="prefetch" href="/assets/js/40.a6dec35a.js"><link rel="prefetch" href="/assets/js/41.07a7f4ab.js"><link rel="prefetch" href="/assets/js/42.f188bb7b.js"><link rel="prefetch" href="/assets/js/43.29ea2f7b.js"><link rel="prefetch" href="/assets/js/44.ead38c63.js"><link rel="prefetch" href="/assets/js/45.08ee1a00.js"><link rel="prefetch" href="/assets/js/46.4f48f43c.js"><link rel="prefetch" href="/assets/js/47.184adaf5.js"><link rel="prefetch" href="/assets/js/48.3ccfc7b3.js"><link rel="prefetch" href="/assets/js/49.a0480c1f.js"><link rel="prefetch" href="/assets/js/5.23d7ebee.js"><link rel="prefetch" href="/assets/js/50.3c9562a4.js"><link rel="prefetch" href="/assets/js/51.3c27459b.js"><link rel="prefetch" href="/assets/js/52.a3bac7e0.js"><link rel="prefetch" href="/assets/js/53.1ebfbb37.js"><link rel="prefetch" href="/assets/js/54.a69f5695.js"><link rel="prefetch" href="/assets/js/55.30fc3dee.js"><link rel="prefetch" href="/assets/js/56.b078a423.js"><link rel="prefetch" href="/assets/js/57.428ea89a.js"><link rel="prefetch" href="/assets/js/58.6dcd7204.js"><link rel="prefetch" href="/assets/js/59.bdb203cc.js"><link rel="prefetch" href="/assets/js/6.35af72fa.js"><link rel="prefetch" href="/assets/js/60.5625ca6e.js"><link rel="prefetch" href="/assets/js/61.d28dcf76.js"><link rel="prefetch" href="/assets/js/62.68e9e7ad.js"><link rel="prefetch" href="/assets/js/63.2c58205f.js"><link rel="prefetch" href="/assets/js/64.d96b60a3.js"><link rel="prefetch" href="/assets/js/65.1e4f0202.js"><link rel="prefetch" href="/assets/js/66.14207ea1.js"><link rel="prefetch" href="/assets/js/67.2cde9a49.js"><link rel="prefetch" href="/assets/js/68.e78a5adf.js"><link rel="prefetch" href="/assets/js/69.97ed1f0f.js"><link rel="prefetch" href="/assets/js/7.65cf686d.js"><link rel="prefetch" href="/assets/js/70.adb12413.js"><link rel="prefetch" href="/assets/js/71.ee612a3d.js"><link rel="prefetch" href="/assets/js/72.410e3f7f.js"><link rel="prefetch" href="/assets/js/73.471e9686.js"><link rel="prefetch" href="/assets/js/74.db59e196.js"><link rel="prefetch" href="/assets/js/75.60812559.js"><link rel="prefetch" href="/assets/js/76.a34f9101.js"><link rel="prefetch" href="/assets/js/77.ef25f076.js"><link rel="prefetch" href="/assets/js/78.aca3f97a.js"><link rel="prefetch" href="/assets/js/79.e3e5b119.js"><link rel="prefetch" href="/assets/js/8.58cc4695.js"><link rel="prefetch" href="/assets/js/80.9865d857.js"><link rel="prefetch" href="/assets/js/81.43cc63d2.js"><link rel="prefetch" href="/assets/js/82.181a6bb0.js"><link rel="prefetch" href="/assets/js/83.09a211ad.js"><link rel="prefetch" href="/assets/js/84.d16beeda.js"><link rel="prefetch" href="/assets/js/85.e060ae87.js"><link rel="prefetch" href="/assets/js/86.d87015bb.js"><link rel="prefetch" href="/assets/js/87.e12c7f32.js"><link rel="prefetch" href="/assets/js/88.2d913c0f.js"><link rel="prefetch" href="/assets/js/89.621532c9.js"><link rel="prefetch" href="/assets/js/9.ad7e170b.js"><link rel="prefetch" href="/assets/js/90.133935f8.js"><link rel="prefetch" href="/assets/js/91.6f6c5f49.js"><link rel="prefetch" href="/assets/js/92.40fd6b28.js"><link rel="prefetch" href="/assets/js/93.6530ebe2.js"><link rel="prefetch" href="/assets/js/94.960db62e.js"><link rel="prefetch" href="/assets/js/95.99c2c6e3.js"><link rel="prefetch" href="/assets/js/96.c1375e9a.js"><link rel="prefetch" href="/assets/js/97.67b2d4ef.js"><link rel="prefetch" href="/assets/js/98.c89e61ec.js"><link rel="prefetch" href="/assets/js/99.6b0255b8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a72ad1e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/en/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/developer-guide/trace-tracking-func.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/developer-guide/trace-tracking-func.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/developer-guide/trace-tracking-func.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/developer-guide/trace-tracking-func.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Plugin Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Developer Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/en/document/developer-guide/" aria-current="page" class="sidebar-link">Create Your First Plugin</a></li><li><a href="/en/document/developer-guide/bytecode-enhancement.html" class="sidebar-link">Bytecode Enhancement</a></li><li><a href="/en/document/developer-guide/package-structure.html" class="sidebar-link">Plugin Structure</a></li><li><a href="/en/document/developer-guide/plugin-configuration.html" class="sidebar-link">Plugin Configuration</a></li><li><a href="/en/document/developer-guide/dynamic-config-func.html" class="sidebar-link">Dynamic Configuration Function</a></li><li><a href="/en/document/developer-guide/heartbeat-func.html" class="sidebar-link">Heartbeat Function</a></li><li><a href="/en/document/developer-guide/trace-tracking-func.html" aria-current="page" class="active sidebar-link">Link Function</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/en/document/developer-guide/trace-tracking-func.html#function-introduction" class="sidebar-link">Function Introduction</a></li><li class="sidebar-sub-header"><a href="/en/document/developer-guide/trace-tracking-func.html#developing-examples" class="sidebar-link">Developing Examples</a></li><li class="sidebar-sub-header"><a href="/en/document/developer-guide/trace-tracking-func.html#api-configuration" class="sidebar-link">API &amp; Configuration</a></li></ul></li><li><a href="/en/document/developer-guide/log-func.html" class="sidebar-link">Logging Function</a></li><li><a href="/en/document/developer-guide/third-party-copyright.html" class="sidebar-link">Third Party Copyright Statement</a></li><li><a href="/en/document/developer-guide/version-manage.html" class="sidebar-link">Version Management</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="link-function"><a href="#link-function" class="header-anchor">#</a> Link Function</h1> <p>This document describes how the Sermant plug-in uses the link functionality.</p> <h2 id="function-introduction"><a href="#function-introduction" class="header-anchor">#</a> Function Introduction</h2> <p>In order to meet the high concurrency requirements of the system, the software architecture is becoming more and more complex, and more and more components in the system are becoming distributed. For example, the monolithic architecture is split into microservices, the in-service caches are changed into distributed caches, and the service component communication is changed into distributed messages. Therefore, it is particularly important to mark each execution unit in the traffic link of the distributed system. Through the link labeling, the dependence relationship and execution order between each execution unit in the distributed system traffic link can be obtained, which can be used in many scenarios such as distributed link tracing, link performance analysis, and fault location of distributed system.</p> <p><strong>Sermant</strong> provides the ability to tag a link in a distributed system. Developers only need to select the right execution unit to tag and specify how the link context information is passed along the link.</p> <h2 id="developing-examples"><a href="#developing-examples" class="header-anchor">#</a> Developing Examples</h2> <p>This development example is based on the project created in the <a href="/en/document/developer-guide/" class="router-link-active">Create your first plugin</a> document, which simulates a service call process and uses a <code>HashMap</code> to simulate the communication carrier:</p> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <p><code>SimulateServer</code> simulates a WEB server, where <code>handleRequest</code> simulates the logic for handling requests, and <code>consume</code> is used to invoke downstream services.</p> <p><code>SimulateProvider</code> simulates the downstream service of the WEB server, where <code>handleConsume</code> is used to handle calls from <code>SimulateServer</code>.</p> <p>In order to mark the link completely, it is necessary to mark the key execution units in the distributed system. In this example, two types are mainly involved:</p> <ul><li><p>Link marking of the service provider execution unit: the entry point of each node of the distributed system, where the context information of the current link needs to be extracted through the communication carrier in the distributed system. If there is no link context information, it is marked as a new link.</p></li> <li><p>Link marking of the service consumer execution unit: the exit of each node of the distributed system, here it is necessary to put the tag of the link data into the communication carrier of the distributed system to maintain the continuity of the link.</p></li></ul> <p>Based on the above basis, we mark the links for the service invocation process in the project:</p> <p>First, create a <a href="/en/document/developer-guide/bytecode-enhancement.html#Interceptor">Interceptor</a> for <code>handleRequest</code> in <code>SimulateServer</code> under <code>template\template-plugin</code> in the project, and implement the following logic in it:</p> <blockquote><p>Note: The interceptor is created by referring to <a href="/en/document/developer-guide/" class="router-link-active">Create your first plugin</a>, so we won't repeat it in this development example</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingService</span> tracingService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">TracingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">TracingRequest</span> request <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">TracingRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRawCls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ExtractService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extractService <span class="token operator">=</span> <span class="token punctuation">(</span>tracingRequest<span class="token punctuation">,</span> carrier<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        tracingRequest<span class="token punctuation">.</span><span class="token function">setTraceId</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">TRACE_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tracingRequest<span class="token punctuation">.</span><span class="token function">setParentSpanId</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">PARENT_SPAN_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tracingRequest<span class="token punctuation">.</span><span class="token function">setSpanIdPrefix</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">SPAN_ID_PREFIX</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpanEvent</span><span class="token punctuation">&gt;</span></span> spanEventOptional <span class="token operator">=</span> tracingService<span class="token punctuation">.</span><span class="token function">onProviderSpanStart</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> extractService<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spanEventOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpanEvent</span> spanEvent <span class="token operator">=</span> spanEventOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TraceId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;SpanId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ParentSpanId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getParentSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Class:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Method:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tracingService<span class="token punctuation">.</span><span class="token function">onSpanFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">onThrow</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    tracingService<span class="token punctuation">.</span><span class="token function">onSpanError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>The <code>handleRequest</code> in the <code>SimulateServer</code> is the service provider execution unit of the <code>SimulateServer</code> node in the distributed system. So here use TracingService: : onProviderSpanStart to mark the unit, and through ExtractService defines the ability to link information extracted from communication carrier.</p></blockquote> <p>Then create a <a href="/en/document/developer-guide/bytecode-enhancement.html#Interceptor">Interceptor</a> for <code>consume</code> in the <code>SimulateServer</code>, and implement the following logic in it:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingService</span> tracingService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">TracingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">TracingRequest</span> request <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">TracingRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRawCls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InjectService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> injectService <span class="token operator">=</span> <span class="token punctuation">(</span>spanEvent<span class="token punctuation">,</span> carrier<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        carrier<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">TRACE_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanEvent<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        carrier<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">PARENT_SPAN_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanEvent<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        carrier<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">SPAN_ID_PREFIX</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanEvent<span class="token punctuation">.</span><span class="token function">getNextSpanIdPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpanEvent</span><span class="token punctuation">&gt;</span></span> spanEventOptional <span class="token operator">=</span> tracingService<span class="token punctuation">.</span><span class="token function">onConsumerSpanStart</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> injectService<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spanEventOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpanEvent</span> spanEvent <span class="token operator">=</span> spanEventOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TraceId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;SpanId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ParentSpanId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getParentSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Class:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Method:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tracingService<span class="token punctuation">.</span><span class="token function">onSpanFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">onThrow</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    tracingService<span class="token punctuation">.</span><span class="token function">onSpanError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>SimulateServer</code> in <code>consume</code> for the distributed system, namely <code>SimulateServer</code> the node execution unit service consumers, so here use TracingService: : onConsumerSpanStart to mark the execution unit, And InjectService defines the ability to inject link context information into the communication carrier.</p></blockquote> <p>Create a <a href="/en/document/developer-guide/bytecode-enhancement.html#Interceptor">Interceptor</a> for <code>handleConsume</code> in <code>SimulateProvider</code>, and implement the following logic in it:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingService</span> tracingService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">TracingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">TracingRequest</span> request <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">TracingRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRawCls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ExtractService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extractService <span class="token operator">=</span> <span class="token punctuation">(</span>tracingRequest<span class="token punctuation">,</span> carrier<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        tracingRequest<span class="token punctuation">.</span><span class="token function">setTraceId</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">TRACE_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tracingRequest<span class="token punctuation">.</span><span class="token function">setParentSpanId</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">PARENT_SPAN_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tracingRequest<span class="token punctuation">.</span><span class="token function">setSpanIdPrefix</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">SPAN_ID_PREFIX</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpanEvent</span><span class="token punctuation">&gt;</span></span> spanEventOptional <span class="token operator">=</span> tracingService<span class="token punctuation">.</span><span class="token function">onProviderSpanStart</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> extractService<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spanEventOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpanEvent</span> spanEvent <span class="token operator">=</span> spanEventOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TraceId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;SpanId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ParentSpanId:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getParentSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Class:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Method:&quot;</span> <span class="token operator">+</span> spanEvent<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tracingService<span class="token punctuation">.</span><span class="token function">onSpanFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">onThrow</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    tracingService<span class="token punctuation">.</span><span class="token function">onSpanError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>handleConsume</code> in <code>SimulateProvider</code> is the service provider execution unit of the <code>SimulateServer</code> node in the distributed system. So here use TracingService: : onProviderSpanStart to mark the execution unit, and through ExtractService defines the ability to link information extracted from communication carrier.</p></blockquote> <p>Once the development is complete, follow the <a href="/en/document/developer-guide/#Packaged-build">Packaged build</a> process used to create the first plugin, run <strong>mvn package</strong> in the root directory of the project, and run <code>cd agent/</code> in it with <strong>Sermant</strong> to run the test app. Run <strong>java -javaagent:sermant-agent.jar -jar Application.jar</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">java</span> -javaagent:sermant-agent.jar <span class="token parameter variable">-jar</span> Application.jar
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Loading core library<span class="token punctuation">..</span>. 
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Building argument map<span class="token punctuation">..</span>. 
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Loading sermant agent<span class="token punctuation">..</span>. 
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Load sermant done. 
Good morning<span class="token operator">!</span>
Good afternoon<span class="token operator">!</span>
Good night<span class="token operator">!</span>
</code></pre></div><p>The execution logic defined in the plug-in has been enhanced into the test application. Next, take a look at the logs generated while the program is running:</p> <ol><li><p>Enter the log directory by running <code>cd logs/sermant/core/app/${yyyy-mm-dd}/</code>, where <code>${yyyy-mm-dd}</code> refers to the directory name generated by the runtime based on the date.</p></li> <li><p>Open the log file <code>sermant-0.log</code> and check the log contents. You can see the following log, from which the <code>SpanId</code> and <code>ParentSpanId</code> can be used to restore the link relationship of the app:</p></li></ol> <div class="language-日志 extra-class"><pre class="language-text"><code>[TemplateTracingDeclarer.java] [before:55] [main] TraceId:137232c4-ce6e-4161-b44d-88cd819145e5
[TemplateTracingDeclarer.java] [before:55] [main] SpanId:0
[TemplateTracingDeclarer.java] [before:56] [main] ParentSpanId:null
[TemplateTracingDeclarer.java] [before:57] [main] Class:com.huaweicloud.template.SimulateServer
[TemplateTracingDeclarer.java] [before:58] [main] Method:handleRequest

[TemplateTracingDeclarer.java] [before:88] [main] TraceId:137232c4-ce6e-4161-b44d-88cd819145e5
[TemplateTracingDeclarer.java] [before:89] [main] SpanId:1
[TemplateTracingDeclarer.java] [before:90] [main] ParentSpanId:0
[TemplateTracingDeclarer.java] [before:91] [main] Class:com.huaweicloud.template.SimulateServer
[TemplateTracingDeclarer.java] [before:92] [main] Method:consume

[TemplateTracingDeclarer.java] [before:122] [main] TraceId:137232c4-ce6e-4161-b44d-88cd819145e5
[TemplateTracingDeclarer.java] [before:123] [main] SpanId:1-0-0
[TemplateTracingDeclarer.java] [before:124] [main] ParentSpanId:1
[TemplateTracingDeclarer.java] [before:125] [main] Class:com.huaweicloud.template.SimulateProvider
[TemplateTracingDeclarer.java] [before:126] [main] Method:handleConsume
</code></pre></div><blockquote><p>According to the link marking information carried in the log, the following conclusions can be analyzed</p> <ul><li>All three sets of data have the same <code>TraceId</code>, meaning they are link data for the same link.</li> <li>In <code>SimulateServer</code>, <code>handleRequest</code> is the link entry because its <code>ParentSpanId</code> is <code>null</code>.</li> <li>The <code>ParentSpanId</code> of <code>consume</code> in <code>SimulateServer</code> is <code>0</code>, so it is called by <code>handleRequest</code> in <code>SimulateServer</code>.</li> <li>The <code>ParentSpanId</code> of <code>handleConsume</code> in <code>SimulateProvider</code> is <code>1</code>, so it is called by <code>consume</code> in <code>SimulateServer</code>.</li> <li>The <code>SpanId</code> of <code>handleConsume</code> in <code>SimulateProvider</code> is <code>1-0-0</code>, which is two more than <code>ParentSpanId</code> so it is not the same process as <code>SimulateProvider</code>. The value of the phase difference is <code>0</code>, which can also be inferred that this is the first upstream call on this link.</li></ul> <p>Note: Link marker generation rules can be found in <a href="#Rules">Rules</a></p></blockquote> <p>It can be seen that the link marking for each execution unit in the distributed system can clearly understand the dependency relationship and execution order between each execution unit in the distributed system.</p> <h2 id="api-configuration"><a href="#api-configuration" class="header-anchor">#</a> API &amp; Configuration</h2> <ul><li><strong>Sermant</strong> encapsulates link marking operations for various types of execution units in a distributed system. It is abstracted as a basic service, and it needs to obtain instances when using it.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingService</span> tracingService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">TracingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>For the link marking operation of the service provider execution unit, the entry of each node in the distributed system, the current link context information needs to be extracted through the communication carrier in the distributed system. If there is no link context information, it will be marked as a new link.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>tracingService<span class="token punctuation">.</span><span class="token function">onProviderSpanStart</span><span class="token punctuation">(</span><span class="token class-name">TracingRequest</span> tracingRequest<span class="token punctuation">,</span> <span class="token class-name">ExtractService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> extractService<span class="token punctuation">,</span> <span class="token class-name">T</span> carrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>The service consumer executes the link marking operation of the unit and the exit of each node of the distributed system. Here, the context information of the link data needs to be put into the communication carrier of the distributed system to maintain the continuity of the link.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>tracingService<span class="token punctuation">.</span><span class="token function">onConsumerSpanStart</span><span class="token punctuation">(</span><span class="token class-name">TracingRequest</span> tracingRequest<span class="token punctuation">,</span> <span class="token class-name">InjectService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> injectService<span class="token punctuation">,</span> <span class="token class-name">T</span> carrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>For the link marking operation of the internal execution unit of the service, the internal call of each node in the distributed system only needs to pay attention to the internal call order, without interacting with the communication carrier in the distributed system.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>tracingService<span class="token punctuation">.</span><span class="token function">onNormalSpanStart</span><span class="token punctuation">(</span><span class="token class-name">TracingRequest</span> tracingRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>This marking step is required to operate the end of each unit against the link marking step at the end of each execution unit.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>tracingService<span class="token punctuation">.</span><span class="token function">onSpanFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>The link marking operation for the exception of each execution unit. When each execution unit encounters an exception, it needs to use this marking step.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>tracingService<span class="token punctuation">.</span><span class="token function">onSpanError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="functional-interface"><a href="#functional-interface" class="header-anchor">#</a> Functional Interface</h3> <p>Link labeling requires the ability to extract and inject link context information from the communication carrier of the distributed system. The following two functional interfaces are used to implement these capabilities:</p> <ul><li>Extracting link context information from the communication carrier of a distributed system needs to implement:</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExtractService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Cross-process link tracking requires extracting the link information from the protocol carrier
     */</span>
    <span class="token keyword">void</span> <span class="token function">getFromCarrier</span><span class="token punctuation">(</span><span class="token class-name">TracingRequest</span> tracingRequest<span class="token punctuation">,</span> <span class="token class-name">T</span> carrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>To inject link context information from the communication carrier of a distributed system, implement:</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InjectService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Link tracing across processes needs to put the content of link information into the protocol carrier
     */</span>
    <span class="token keyword">void</span> <span class="token function">addToCarrier</span><span class="token punctuation">(</span><span class="token class-name">SpanEvent</span> spanEvent<span class="token punctuation">,</span> <span class="token class-name">T</span> carrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="rules"><a href="#rules" class="header-anchor">#</a> Rules</h3> <p>The <code>SpanId</code> is a very important data in the link tag data, which indicates the execution order between each execution unit and the parent-child logic. The <code>SpanId</code> of the link tag provided by <strong>Sermant</strong> is as follows:</p> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <p>Service A is the entry point of the link with a <code>SpanId</code> of 0, where a <code>TraceId</code> of the link is generated. Focusing on the <code>SpanId</code> of service B and service C, the most important thing is the <strong>last two values</strong> :</p> <ul><li><p>The last two bits of service B are 0-0, where the first one indicates that service B was the <strong>first</strong> invocation of service A, and the second one indicates that this information belongs to the first execution unit in service B.</p></li> <li><p>The last two bits of the C service are 1-0, where the first one indicates that the C service is the <strong>second</strong> invocation of the A service, and the second one indicates that the information belongs to the first execution unit in the C service.</p></li></ul> <p>Except for the link information of the execution unit at the entrance of the distributed system, which does not have <code>ParentSpanId</code>, the link information of other execution units is available, and the user can clearly know who his upstream execution unit is. Through this relationship, the complete link information can be connected in series eventually.</p> <p>With the above description, the <code>SpanId</code> generation rules provided by <strong>Sermant</strong> should be clear.</p> <h3 id="notes"><a href="#notes" class="header-anchor">#</a> Notes</h3> <p>For the link context information, the context information passed in the distributed system is in the form of <code>key:value</code>. The following is explained for the <code>key</code> of the link context information:</p> <ul><li><code>sermant-trace-id</code>, which holds the link's <code>TraceId</code> to identify a link.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">TRACE_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>sermant-parent-span-id</code>, which holds the current <code>SpanId</code> to pass downstream to inform the downstream of its <code>SpanId</code> value, which is used to concatenate upstream and downstream execution units.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">PARENT_SPAN_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>sermant-span-id-prefix</code>, which holds the prefix that defines its own <code>SpanId</code>, which identifies its own spanid.</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">SPAN_ID_PREFIX</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/27/2023, 8:11:12 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/en/document/developer-guide/heartbeat-func.html" class="prev">
        Heartbeat Function
      </a></span> <span class="next"><a href="/en/document/developer-guide/log-func.html">
        Logging Function
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.5ad3fa69.js" defer></script><script src="/assets/js/3.0215ffee.js" defer></script><script src="/assets/js/1.b15421ba.js" defer></script><script src="/assets/js/37.f21874a8.js" defer></script><script src="/assets/js/15.e73a6d7c.js" defer></script>
  </body>
</html>
