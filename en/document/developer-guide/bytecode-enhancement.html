<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bytecode Enhancement | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh based on Bytecode Enhancement">
    
    <link rel="preload" href="/assets/css/0.styles.87ac6783.css" as="style"><link rel="preload" href="/assets/js/app.df8eddc2.js" as="script"><link rel="preload" href="/assets/js/3.06f127bc.js" as="script"><link rel="preload" href="/assets/js/1.c8bacf5b.js" as="script"><link rel="preload" href="/assets/js/27.09e84572.js" as="script"><link rel="prefetch" href="/assets/js/10.dc8ff4c8.js"><link rel="prefetch" href="/assets/js/100.c5222045.js"><link rel="prefetch" href="/assets/js/101.78152f69.js"><link rel="prefetch" href="/assets/js/102.35ea26ff.js"><link rel="prefetch" href="/assets/js/103.bf055e03.js"><link rel="prefetch" href="/assets/js/104.27fa37b0.js"><link rel="prefetch" href="/assets/js/105.bfdb15e5.js"><link rel="prefetch" href="/assets/js/106.e8c12c36.js"><link rel="prefetch" href="/assets/js/107.7f1a13e7.js"><link rel="prefetch" href="/assets/js/108.2d90bf2e.js"><link rel="prefetch" href="/assets/js/109.320b7cf3.js"><link rel="prefetch" href="/assets/js/11.bcd0a917.js"><link rel="prefetch" href="/assets/js/110.1042ea95.js"><link rel="prefetch" href="/assets/js/111.94ec9618.js"><link rel="prefetch" href="/assets/js/112.a1c7e784.js"><link rel="prefetch" href="/assets/js/113.81d1d9c5.js"><link rel="prefetch" href="/assets/js/114.cd06da03.js"><link rel="prefetch" href="/assets/js/12.fd6a031f.js"><link rel="prefetch" href="/assets/js/13.7e37daca.js"><link rel="prefetch" href="/assets/js/14.199c38f6.js"><link rel="prefetch" href="/assets/js/15.900a8374.js"><link rel="prefetch" href="/assets/js/16.dc00a508.js"><link rel="prefetch" href="/assets/js/17.7b9f75d8.js"><link rel="prefetch" href="/assets/js/18.dd5aeee6.js"><link rel="prefetch" href="/assets/js/19.922def51.js"><link rel="prefetch" href="/assets/js/20.bac96cfe.js"><link rel="prefetch" href="/assets/js/21.75729028.js"><link rel="prefetch" href="/assets/js/22.43cc7ae1.js"><link rel="prefetch" href="/assets/js/23.80aecc10.js"><link rel="prefetch" href="/assets/js/24.d862bfe2.js"><link rel="prefetch" href="/assets/js/25.d2bfc810.js"><link rel="prefetch" href="/assets/js/26.fe2d3037.js"><link rel="prefetch" href="/assets/js/28.44ffc507.js"><link rel="prefetch" href="/assets/js/29.54bad9a2.js"><link rel="prefetch" href="/assets/js/30.4341a551.js"><link rel="prefetch" href="/assets/js/31.a43a1a26.js"><link rel="prefetch" href="/assets/js/32.fae9f060.js"><link rel="prefetch" href="/assets/js/33.d9926dae.js"><link rel="prefetch" href="/assets/js/34.d8960a15.js"><link rel="prefetch" href="/assets/js/35.4d936c34.js"><link rel="prefetch" href="/assets/js/36.69b2f3fb.js"><link rel="prefetch" href="/assets/js/37.f1740a13.js"><link rel="prefetch" href="/assets/js/38.c2bf7b2d.js"><link rel="prefetch" href="/assets/js/39.8873348c.js"><link rel="prefetch" href="/assets/js/4.7add7152.js"><link rel="prefetch" href="/assets/js/40.55cec7c8.js"><link rel="prefetch" href="/assets/js/41.377fb9d6.js"><link rel="prefetch" href="/assets/js/42.d220a2de.js"><link rel="prefetch" href="/assets/js/43.6cfcf2bd.js"><link rel="prefetch" href="/assets/js/44.ef4e02ab.js"><link rel="prefetch" href="/assets/js/45.cb46aba8.js"><link rel="prefetch" href="/assets/js/46.5362eeb2.js"><link rel="prefetch" href="/assets/js/47.706a7dbb.js"><link rel="prefetch" href="/assets/js/48.33159e6a.js"><link rel="prefetch" href="/assets/js/49.1a3cd92f.js"><link rel="prefetch" href="/assets/js/5.4a333fb7.js"><link rel="prefetch" href="/assets/js/50.0a891537.js"><link rel="prefetch" href="/assets/js/51.0f656575.js"><link rel="prefetch" href="/assets/js/52.a94dbeda.js"><link rel="prefetch" href="/assets/js/53.4d4b62c4.js"><link rel="prefetch" href="/assets/js/54.b1845a92.js"><link rel="prefetch" href="/assets/js/55.ef62bf5d.js"><link rel="prefetch" href="/assets/js/56.a2f0ad08.js"><link rel="prefetch" href="/assets/js/57.a0e4792b.js"><link rel="prefetch" href="/assets/js/58.3b83140b.js"><link rel="prefetch" href="/assets/js/59.255861a7.js"><link rel="prefetch" href="/assets/js/6.72029eac.js"><link rel="prefetch" href="/assets/js/60.f1229caf.js"><link rel="prefetch" href="/assets/js/61.c00aff9b.js"><link rel="prefetch" href="/assets/js/62.4125fce4.js"><link rel="prefetch" href="/assets/js/63.2f37913f.js"><link rel="prefetch" href="/assets/js/64.ba4db5b6.js"><link rel="prefetch" href="/assets/js/65.5917e76d.js"><link rel="prefetch" href="/assets/js/66.929b4eb4.js"><link rel="prefetch" href="/assets/js/67.8f734315.js"><link rel="prefetch" href="/assets/js/68.33a8de78.js"><link rel="prefetch" href="/assets/js/69.0e3fe7d9.js"><link rel="prefetch" href="/assets/js/7.698dd478.js"><link rel="prefetch" href="/assets/js/70.c311703c.js"><link rel="prefetch" href="/assets/js/71.b7826362.js"><link rel="prefetch" href="/assets/js/72.6d452995.js"><link rel="prefetch" href="/assets/js/73.9afc2fcf.js"><link rel="prefetch" href="/assets/js/74.cc2dec6d.js"><link rel="prefetch" href="/assets/js/75.83cc918a.js"><link rel="prefetch" href="/assets/js/76.e25fcaba.js"><link rel="prefetch" href="/assets/js/77.ecd3dfcc.js"><link rel="prefetch" href="/assets/js/78.61a9dc3a.js"><link rel="prefetch" href="/assets/js/79.52a8f851.js"><link rel="prefetch" href="/assets/js/8.10750ce9.js"><link rel="prefetch" href="/assets/js/80.a56d59b3.js"><link rel="prefetch" href="/assets/js/81.4ce89491.js"><link rel="prefetch" href="/assets/js/82.107c34fa.js"><link rel="prefetch" href="/assets/js/83.dd28b43e.js"><link rel="prefetch" href="/assets/js/84.9f3a4808.js"><link rel="prefetch" href="/assets/js/85.fc619b9d.js"><link rel="prefetch" href="/assets/js/86.233cebc6.js"><link rel="prefetch" href="/assets/js/87.1460eff8.js"><link rel="prefetch" href="/assets/js/88.58ac31af.js"><link rel="prefetch" href="/assets/js/89.510960d2.js"><link rel="prefetch" href="/assets/js/9.7f57e4b0.js"><link rel="prefetch" href="/assets/js/90.a3f0b945.js"><link rel="prefetch" href="/assets/js/91.677bfd74.js"><link rel="prefetch" href="/assets/js/92.d690326d.js"><link rel="prefetch" href="/assets/js/93.e689ca55.js"><link rel="prefetch" href="/assets/js/94.7e4b64a9.js"><link rel="prefetch" href="/assets/js/95.dd730e36.js"><link rel="prefetch" href="/assets/js/96.237aba3b.js"><link rel="prefetch" href="/assets/js/97.de19be73.js"><link rel="prefetch" href="/assets/js/98.6e0a4794.js"><link rel="prefetch" href="/assets/js/99.c4afbd41.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87ac6783.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/en/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/sermant-io/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/developer-guide/bytecode-enhancement.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/developer-guide/bytecode-enhancement.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/sermant-io/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/developer-guide/bytecode-enhancement.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/developer-guide/bytecode-enhancement.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Plugin Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Developer Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/en/document/developer-guide/" aria-current="page" class="sidebar-link">Create Your First Plugin</a></li><li><a href="/en/document/developer-guide/bytecode-enhancement.html" aria-current="page" class="active sidebar-link">Bytecode Enhancement</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/en/document/developer-guide/bytecode-enhancement.html#enhanced-statement" class="sidebar-link">Enhanced Statement</a></li><li class="sidebar-sub-header"><a href="/en/document/developer-guide/bytecode-enhancement.html#class-matcher" class="sidebar-link">Class Matcher</a></li><li class="sidebar-sub-header"><a href="/en/document/developer-guide/bytecode-enhancement.html#method-matcher" class="sidebar-link">Method Matcher</a></li><li class="sidebar-sub-header"><a href="/en/document/developer-guide/bytecode-enhancement.html#interceptor" class="sidebar-link">Interceptor</a></li></ul></li><li><a href="/en/document/developer-guide/package-structure.html" class="sidebar-link">Plugin Structure</a></li><li><a href="/en/document/developer-guide/plugin-configuration.html" class="sidebar-link">Plugin Configuration</a></li><li><a href="/en/document/developer-guide/dynamic-config-func.html" class="sidebar-link">Dynamic Configuration Function</a></li><li><a href="/en/document/developer-guide/sermant-xds-service.html" class="sidebar-link">xDS Service</a></li><li><a href="/en/document/developer-guide/heartbeat-func.html" class="sidebar-link">Heartbeat Function</a></li><li><a href="/en/document/developer-guide/trace-tracking-func.html" class="sidebar-link">Link Function</a></li><li><a href="/en/document/developer-guide/log-func.html" class="sidebar-link">Logging Function</a></li><li><a href="/en/document/developer-guide/third-party-copyright.html" class="sidebar-link">Third Party Copyright Statement</a></li><li><a href="/en/document/developer-guide/version-manage.html" class="sidebar-link">Version Management</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="bytecode-enhancement"><a href="#bytecode-enhancement" class="header-anchor">#</a> Bytecode Enhancement</h1> <p>In each <code>plugin main module</code> of  <strong>Sermant</strong> plugin, some enhancement logic can be declared to enhance bytecode for certain methods of the host application in order to achieve a certain function, so it is an important topic to describe what class and class methods to enhance.</p> <h2 id="enhanced-statement"><a href="#enhanced-statement" class="header-anchor">#</a> Enhanced Statement</h2> <p>In plugin development, the bytecode enhancement declaration needs to be defined in the <a href="/en/document/developer-guide/package-structure.html#Plugin-Main-Module">main module of the plugin</a>, declaring the plugin bytecode enhancement logic requires implementing <a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/sermant-io/sermant/core/plugin/agent/declarer/PluginDeclarer.java" target="_blank" rel="noopener noreferrer">PluginDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> interface, which consists of three interface methods:</p> <ul><li><code>getClassMatcher</code> method is used to get the <a href="#Class-Matcher">ClassMatcher</a> of the enhanced class .</li> <li><code>getInterceptDeclarers</code> method is used to get the <a href="#Method-Matcher">MethodMatcher</a> of the intercepting method of the enhanced class, and the <a href="#Interceptor">Interceptor</a> declared for the interception point, they are encapsulated in intercept statements <a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/sermant-io/sermant/core/plugin/agent/declarer/InterceptDeclarer.java" target="_blank" rel="noopener noreferrer">InterceptDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><code>getSuperTpeDecarers</code> is used to get super class declaration <a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/plugin/agent/declarer/SuperTypeDeclarer.java" target="_blank" rel="noopener noreferrer">SuperTypeDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of plugin.</li></ul> <p>After the implementation is complete, you need to add the SPI profile of the PluginDeclarer interface:</p> <ul><li>Add <code>META-INF/services</code> file in <code>resources</code> directory.</li> <li>Add <code>io.sermant.core.plugin.agent.declarer.PluginDeclarer</code> profile file in <code>META-INF/services</code>.</li> <li>In the above file, separated by exchange behavior, type the fully qualified names of all the classes in the plugin package that implement the PluginDeclarer interface.</li></ul> <h2 id="class-matcher"><a href="#class-matcher" class="header-anchor">#</a> Class Matcher</h2> <p>For <a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/plugin/agent/matcher/ClassMatcher.java" target="_blank" rel="noopener noreferrer">ClassMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, two types of matchers are provided in the core module：</p> <p><a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/plugin/agent/matcher/ClassTypeMatcher.java" target="_blank" rel="noopener noreferrer">ClassTypeMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(Class type matcher)</p> <ul><li><p>Matching by name, which is the most common method of locating, can be obtained by the following methods:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${class reference}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${class reference}</code> is the fully qualified name of the enhanced class.</p></li> <li><p>Matches multiple classes by name, belonging to the plural version of <code>nameEquals</code>, which can be obtained by the following method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">&quot;${class reference array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${class reference array}</code> is a fully qualified mutable array of the enhanced class.</p></li></ul> <p><a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/plugin/agent/matcher/ClassFuzzyMatcher.java" target="_blank" rel="noopener noreferrer">ClassFuzzyMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（Fuzzy matcher of class）</p> <ul><li><p>The enhanced class is located by the fully qualified name prefix, which can be obtained by the following method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">namePrefixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${prefix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${prefix}</code> is a fully qualified name prefix.</p></li> <li><p>The fully qualified name suffix is used to locate the enhanced class, which can be obtained by the following method：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameSuffixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${suffix}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>${suffix}</code> is a fully qualified name suffix.</p></li> <li><p>The enhanced class is located by a fully qualified name infix, which can be obtained by the following method：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameinfixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${infix}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>${infix}</code> is a fully qualified name infix.</p></li> <li><p>Locate the enhanced class by matching the fully qualified name with a regular expression, which can be obtained by the following methods:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameMatches</span><span class="token punctuation">(</span><span class="token string">&quot;${pattern}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>${pattern}</code> is a regular expression.</p></li> <li><p>The annotation is used to locate the class that is modified by the annotation, which can be obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">isAnnotationWith</span><span class="token punctuation">(</span><span class="token string">&quot;${annotation reference array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${annotation reference array}</code> a fully qualified mutable array for annotations.</p></li> <li><p>The superclass locates the subclass of the class, which can be obtained by the following method：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">isExtendedFrom</span><span class="token punctuation">(</span><span class="token string">&quot;${super class array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${super class array}</code> is a superclass variable array. Due to Java's inheritance rules, this array can only have one <code>Class</code> and the rest must be all <code>interfaces</code>.</p></li> <li><p>A logical operation that matches is true if none of the matchers match：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>${class matcher array}</code> is a variable length array for matchers.</p></li> <li><p>A logical operation that matches is true when all matchers match：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>${class matcher array}</code> is a variable length array for matchers.</p></li> <li><p>The logical operation of matching, where one of the matchers matches is true：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>${class matcher array}</code> is a variable length array for matchers.</p></li></ul> <h2 id="method-matcher"><a href="#method-matcher" class="header-anchor">#</a> Method Matcher</h2> <p>For <a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/plugin/agent/matcher/MethodMatcher.java" target="_blank" rel="noopener noreferrer">MethodMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, a variety of matching methods are provided:</p> <ul><li><p>Full matching：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Name matching：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${method name}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${method name}</code> is method name。</p></li> <li><p>Matching static method：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Matching constructor：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Matching multiple methods：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">&quot;${method name array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${method name array}</code> is an array of method names.</p></li> <li><p>Match by method name prefix：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">namePrefixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name prefix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${method name prefix}</code> is a method name prefix.</p></li> <li><p>Match by method name suffix：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameSuffixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name suffix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${method name suffix}</code> is a method name suffix.</p></li> <li><p>Match by method name infix：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameinfixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name infix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${method name infix}</code> is a method name infix.</p></li> <li><p>Match according to regular expression：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameMatches</span><span class="token punctuation">(</span><span class="token string">&quot;${pattern}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${pattern}</code> is regular expression.</p></li> <li><p>Matches the method modified by the incoming annotation：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isAnnotatedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${annotations array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${annotations array}</code> is annotation set.</p></li> <li><p>Matches the method with the specified number of inputs：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">paramCountEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${param count}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${param count}</code> is  the specified number of inputs.</p></li> <li><p>Matches the method of the specified input type：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">paramTypeEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${param type array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${param type array}</code> is an input type set.</p></li> <li><p>Matches a method of the specified return value type：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">resultTypeEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${result type}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${result type}</code> is return value type.</p></li> <li><p>Logical operation, the result is true if the method matcher set does not match at all:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${element matcher array}</code> is method matcher set.</p></li> <li><p>Logical operation, the result is true if the method matcher set matches all:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${element matcher array}</code> is method matcher set.</p></li> <li><p>Logical operation where the result is true if one of the method matchers in the set matches:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>${element matcher array}</code> is method matcher set.</p></li></ul> <p>For more method matching methods, see the method with the <code>MethodDescription</code> generic in <a href="https://javadoc.io/doc/net.bytebuddy/byte-buddy/latest/net/bytebuddy/matcher/ElementMatchers.html" target="_blank" rel="noopener noreferrer">byte-buddy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="native-class-enhancement"><a href="#native-class-enhancement" class="header-anchor">#</a> Native Class Enhancement</h3> <p>There is no difference between enhancing native classes and enhancing ordinary classes in terms of enhancement definition and interceptor writing, but it is desirable for plugin developers to enhance native classes as little as possible for two reasons:</p> <ul><li>Enhancing native classes may lead to unpredictable errors. Since native classes are widely used during development, enhancing them could potentially impact other plugins or host functions that rely on these classes.</li> <li>Enhancing certain native class methods used during the enhancement of Sermant may result in class circular dependency errors. For example, the Sermant class loader uses the <code>java.net.URL</code> class when loading classes. If the constructor of the <code>URL</code> class is enhanced in a plugin, the JVM may throw a <code>ClassCircularityError</code> after the host application mounts the Agent and starts.</li></ul> <p>To sum up, The ability to enhance <em>Java</em> native classes is provided in <a href="https://github.com/sermant-io/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core function module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but it is not recommended to enhance them without restriction, if there are multiple enhancement points to choose from, the common class is preferred.</p> <blockquote><p>In the <a href="/en/document/faq/framework.html">Sermant Framework FAQ</a>, we have listed the known <a href="/en/document/faq/framework.html">native classes that Sermant does not support for enhancement</a>.</p></blockquote> <h2 id="interceptor"><a href="#interceptor" class="header-anchor">#</a> Interceptor</h2> <p>Interceptors are used to define the enhancement logic for the classes being enhanced. In Sermant's interceptors, the three phases—Before, After, and Throw—together form the complete lifecycle of an interceptor, providing general capabilities such as skipping method execution, modifying method parameters, altering method return values, and modifying thrown exceptions.</p> <ul><li><a href="https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-god/src/main/java/io/sermant/core/plugin/agent/interceptor/Interceptor.java" target="_blank" rel="noopener noreferrer">Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: The interceptor interface contains three methods—<code>before</code>, <code>after</code>, and <code>onThrow</code>—which correspond to the three phases of the interceptor's lifecycle. The <code>ExecuteContext</code> parameter represents the execution context of the plugin, encapsulating all the parameters needed for the interceptor to operate:
<ul><li><code>before</code>: The pre-method, corresponding to the Before phase of the interceptor lifecycle. This method is executed before the interception point. Using the <code>ExecuteContext</code> parameter, you can modify method arguments, skip the execution of the host method at the interception point, and perform other operations. Note that when enhancing constructors, the execution of the constructor cannot be skipped.</li> <li><code>after</code>: The post-method, corresponding to the After phase of the interceptor lifecycle. The <code>after</code> method is executed after the interception point has completed execution, and the method's return value can be modified through the <code>ExecuteContext</code> parameter.</li> <li><code>onThrow</code>: The exception handling method, corresponding to the Throw phase of the interceptor lifecycle. This method is triggered only when an exception is thrown at the interception point. If the exception is caught within the method, the <code>onThrow</code> method cannot be triggered. In the <code>onThrow</code> method, the thrown exception can be modified using the <code>ExecuteContext</code> parameter. If the exception is set to <code>null</code>, the method will no longer throw an exception.</li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/6/2024, 9:55:26 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/en/document/developer-guide/" class="prev router-link-active">
        Create Your First Plugin
      </a></span> <span class="next"><a href="/en/document/developer-guide/package-structure.html">
        Plugin Structure
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.df8eddc2.js" defer></script><script src="/assets/js/3.06f127bc.js" defer></script><script src="/assets/js/1.c8bacf5b.js" defer></script><script src="/assets/js/27.09e84572.js" defer></script>
  </body>
</html>
