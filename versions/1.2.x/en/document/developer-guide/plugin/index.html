<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Introduction | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/versions/1.2.x/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh Solution Based on JavaAgent">
    
    <link rel="preload" href="/versions/1.2.x/assets/css/0.styles.f6dcac6f.css" as="style"><link rel="preload" href="/versions/1.2.x/assets/js/app.4759eb35.js" as="script"><link rel="preload" href="/versions/1.2.x/assets/js/3.2e41a223.js" as="script"><link rel="preload" href="/versions/1.2.x/assets/js/1.b15421ba.js" as="script"><link rel="preload" href="/versions/1.2.x/assets/js/32.5c1bfb7d.js" as="script"><link rel="prefetch" href="/versions/1.2.x/assets/js/10.bb21a065.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/100.8661a614.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/101.1209cd4e.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/102.7db03555.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/103.a5520c78.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/11.60305907.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/12.34d38cf9.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/13.2323fadd.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/14.5c48c48e.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/15.e73a6d7c.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/16.fec41699.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/17.a50cbc7b.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/18.e183602e.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/19.089fd575.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/20.7aa203e0.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/21.db595f8d.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/22.0231a508.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/23.41541ac3.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/24.9fee28b5.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/25.934414a8.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/26.6f96e608.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/27.bca7464e.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/28.d8c19794.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/29.4f5a0b40.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/30.13e02089.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/31.d6004839.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/33.e95986f9.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/34.2220821f.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/35.a41cd9d8.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/36.1c7d21f5.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/37.3e83aa84.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/38.27301a57.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/39.2383f4b3.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/4.e3cce00f.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/40.158bbbd7.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/41.71018369.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/42.3878163d.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/43.3d48c843.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/44.f2cb9c94.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/45.4533e693.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/46.9437a386.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/47.7c6aa71b.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/48.cf7a66f2.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/49.b98271d3.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/5.1513b1e3.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/50.a5a182ae.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/51.784d25c0.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/52.c12d736c.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/53.b6cd505a.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/54.6f80eec2.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/55.74099ea6.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/56.620764e6.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/57.03a71448.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/58.1bb39475.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/59.fcd252b7.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/6.564e5073.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/60.2ac962e1.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/61.32085de3.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/62.2a166985.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/63.c4b72fe1.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/64.d1026550.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/65.72a56aeb.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/66.ca7eee11.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/67.956ec1f3.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/68.62637541.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/69.c27efb0b.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/7.c34496d9.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/70.c54caa41.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/71.27bc2a53.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/72.267b2cfa.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/73.d5044756.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/74.ea3ce38c.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/75.36d0bb5f.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/76.da14e89a.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/77.3b3a489e.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/78.e793ca04.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/79.7d01be61.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/8.2c82eb99.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/80.a4e3f70c.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/81.cfe5bfed.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/82.93eceda0.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/83.586dc300.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/84.2da2cc3b.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/85.a8cef901.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/86.c91d7be0.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/87.d7ebfceb.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/88.1000fb3b.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/89.36454066.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/9.e914bb1e.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/90.cb2922b5.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/91.7a143de5.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/92.f317a562.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/93.3f5507bc.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/94.e8243c5d.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/95.2d1d8acf.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/96.ee10329c.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/97.4eebc72a.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/98.8a380b0c.js"><link rel="prefetch" href="/versions/1.2.x/assets/js/99.1329b7e4.js">
    <link rel="stylesheet" href="/versions/1.2.x/assets/css/0.styles.f6dcac6f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/versions/1.2.x/en/" class="home-link router-link-active"><img src="/versions/1.2.x/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/versions/1.2.x/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/versions/1.2.x/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/versions/1.2.x/zh/" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/versions/1.2.x/en/document/developer-guide/plugin/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/versions/1.2.x/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/versions/1.2.x/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/versions/1.2.x/zh/" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/versions/1.2.x/en/document/developer-guide/plugin/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Start</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/versions/1.2.x/en/document/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/versions/1.2.x/en/document/QuickStart.html" class="sidebar-link">Quick Start</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Plugin Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developer Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h1> <p>This document mainly explains the plug-in development of <strong>Sermant</strong>.</p> <h2 id="plugin-structure"><a href="#plugin-structure" class="header-anchor">#</a> Plugin Structure</h2> <p>A <strong>Sermant</strong> plugin module contains the following things</p> <ul><li><code>Plugin Main Module(plugin)</code>, This module is mainly used to declare bytecode enhancement and plugin service interface definitions</li> <li><code>Plugin Service Module(service)</code>, This module is used to provide the plugin service interface implementation for the <code>Plugin Main Module(plugin)</code></li></ul> <p>Before we start, it's important to agree that in <code>plugin</code> modules, developers can only use the <em>Java</em> native API and the <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and cannot rely on or use any third-party dependencies other than <code>byte-buddy</code>. If the business needs to use other third-party dependencies, you can only define the interface in the <code>plugin</code> module and write the implementation in the <code>service</code> module. Refer to the <a href="/versions/1.2.x/en/document/developer-guide/UserGuide/plugin.html#Add-Plugin-Module">Plugin Module</a> for more information.</p> <h3 id="plugin-main-module"><a href="#plugin-main-module" class="header-anchor">#</a> Plugin Main Module</h3> <p>Write <strong>enhanced definition</strong>, <strong>interceptor</strong>, and <strong>plugin service interface</strong> in this module. No third party dependencies can be introduced in this module.</p> <h3 id="plugin-service-module"><a href="#plugin-service-module" class="header-anchor">#</a> Plugin Service Module</h3> <p>Comparing to <strong>Plugin Main Module</strong>:</p> <ul><li>can only write a <strong>plugin configuration</strong> and <strong>plugin service interface</strong> implementation, and cannot write **enhancement definition ** <strong>interceptor</strong> and <strong>plugins service interface</strong>.</li> <li>allow the freedom to add third-party dependencies as needed. When packaging, you need to provide a way to export dependencies, you can use the <code>shade</code> plugin or <code>assembly</code> plugin to export the dependency <em>jar</em> package, or you can directly use the <code>dependency</code> plugin to export the dependency package.</li> <li>the corresponding <strong>Plugin Main Module</strong> is provided in its pom.</li></ul> <h2 id="enhanced-logic"><a href="#enhanced-logic" class="header-anchor">#</a> Enhanced logic</h2> <p>The core capability of <strong>Sermant</strong> is to do non-invasive bytecode enhancements to the host application, which are plug-in enabled. In each <strong>Sermant</strong> plugin's <strong>Plugin Main Module(plugin)</strong>, it is possible to declare some enhancement logic that makes bytecode enhancements to some particular method of the host application, so it is an important subject to describe what class and how that class is enhanced.</p> <p>The declaration plugin enhancement logic needs to implement <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/declarer/PluginDeclarer.java" target="_blank" rel="noopener noreferrer">PluginDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> interface, there are three interface methods：</p> <ul><li><code>getClassMatcher</code> used to get the matcher<a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassMatcher.java" target="_blank" rel="noopener noreferrer">ClassMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of the enhanced class。</li> <li><code>getInterceptDeclarers</code> used to get the matcher<a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/MethodMatcher.java" target="_blank" rel="noopener noreferrer">MethodMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of method in the enhanced class, and the interceptor declared for the interception point, they are encapsulated in <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/declarer/InterceptDeclarer.java" target="_blank" rel="noopener noreferrer">InterceptDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li><code>getSuperTpeDecarers</code> gets the plugin's superclass declaration<a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/declarer/SuperTypeDeclarer.java" target="_blank" rel="noopener noreferrer">SuperTypeDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="class-matcher"><a href="#class-matcher" class="header-anchor">#</a> Class Matcher</h3> <p>The matcher <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassMatcher.java" target="_blank" rel="noopener noreferrer">ClassMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which provides two types of matchers in the core module:</p> <p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassTypeMatcher.java" target="_blank" rel="noopener noreferrer">ClassTypeMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(the matcher for class name)</p> <ul><li><p>The most common way to do this is purely by name matching, which is obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${class reference}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${class reference}</code> is the full qualified class name of the enhanced class.</p></li> <li><p>Matching multiple classes by name, which is the plural version of <code>nameEquals</code>, can be obtained with the following method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">&quot;${class reference array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${class reference array}</code> is a full qualified class name mutable array of the enhanced class.</p></li></ul> <p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassFuzzyMatcher.java" target="_blank" rel="noopener noreferrer">ClassFuzzyMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（the fuzzy matcher of class name）</p> <ul><li><p>The enhanced class is located by the prefix of full qualified class name, which can be obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">namePrefixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${prefix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${prefix}</code> is the prefix of full qualified class name.</p></li> <li><p>The enhanced class is located by the suffix of full qualified class name, which can be retrieved as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameSuffixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${suffix}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${suffix}</code> is the suffix of full qualified class name.</p></li> <li><p>The enhanced class is located by the infix of full qualified class name, which can be obtained as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameinfixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${infix}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${infix}</code> is the infix of full qualified class name.</p></li> <li><p>The enhanced class is located by matching the full qualified class name with a regular expression, which can be obtained as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameMatches</span><span class="token punctuation">(</span><span class="token string">&quot;${pattern}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${pattern}</code> is a regular expression.</p></li> <li><p>The enhanced class is located by annotation decorated, which can be obtained as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">isAnnotationWith</span><span class="token punctuation">(</span><span class="token string">&quot;${annotation reference array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${annotation reference array}</code> is a full qualified class name array of annotations.</p></li> <li><p>Locating a subclass by means of a superclass can be obtained using the following methods:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">isExtendedFrom</span><span class="token punctuation">(</span><span class="token string">&quot;${super class array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${super class array}</code> is a superclass mutable array. Due to Java inheritance rules, the array can only have one <code>class</code>, the rest must be <code>interface</code>.</p></li> <li><p>A matching logical operation, which is true when all matchers do not match:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${class matcher array}</code> is a variable-length array of matcher.</p></li> <li><p>A matching logical operation, which is true if the matcher matches all of them:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${class matcher array}</code> is a variable-length array of matcher.</p></li> <li><p>A matching logical operation, which is true if one of the matcher matches:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${class matcher array}</code> is a variable-length array of matcher.</p></li></ul> <h3 id="method-matcher"><a href="#method-matcher" class="header-anchor">#</a> Method Matcher</h3> <p>For method interception points <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/MethodMatcher.java" target="_blank" rel="noopener noreferrer">MethodMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we provide a variety of matching methods:</p> <ul><li><p>Match any method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Match by method name:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${method name}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name}</code> is the method name.</p></li> <li><p>Match static method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Match constructor:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Match multiple methods:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">&quot;${method name array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name array}</code> is an array of method names.</p></li> <li><p>Match by prefix of method name:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">namePrefixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name prefix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name prefix}</code> is the prefix of method name .</p></li> <li><p>Match by suffix of method name:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameSuffixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name suffix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name suffix}</code> is the suffix of method name.</p></li> <li><p>Match by infix of method name：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameinfixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name infix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name infix}</code> is the infix of method name.</p></li> <li><p>Match by regular expression:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameMatches</span><span class="token punctuation">(</span><span class="token string">&quot;${pattern}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${pattern}</code> is a regular expression.</p></li> <li><p>Matches by annotation:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isAnnotatedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${annotations array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${annotations array}</code> is the annotation set.</p></li> <li><p>Match by specified number of arguments:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">paramCountEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${param count}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${param count}</code> is the number of input parameters.</p></li> <li><p>Match by the specific type of argument:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">paramTypeEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${param type array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${param type array}</code> is the set of input types.</p></li> <li><p>Match by return type</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">resultTypeEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${result type}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${result type}</code> is the return type.</p></li> <li><p>Logical operation, where the result is true if the method matcher set does not match at all.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${element matcher array}</code> is the set of method matcher.</p></li> <li><p>Logical operation, where the result is true if the method matcher set fully matches.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${element matcher array}</code> is the set of method matcher.</p></li> <li><p>Logical operation, where the result is true if method matcher set matches one of the result.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${element matcher array}</code> is the set of method matcher.</p></li></ul> <p>For more methods matching method, refer to <a href="https://javadoc.io/doc/net.bytebuddy/byte-buddy/latest/net/bytebuddy/matcher/ElementMatchers.html" target="_blank" rel="noopener noreferrer">byte-buddy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> methods with a generic type of <code>MethodDescription</code> .</p> <p>Don't forget to add the <em>SPI</em> configuration file for the <code>PluginDeclarer</code> interface:</p> <ul><li>Add <code>META-INF/services</code> folder under <code>resources</code>.</li> <li>Add <code>com.huaweicloud.sermant.core.plugin.agent.declarer.PluginDeclarer</code> under <code>META-INF/services</code> .</li> <li>In the above file, type all the enhancements definitions of <code>PluginDeclarer</code> in the plugin package separated with LF.</li></ul> <h4 id="原生类增强"><a href="#原生类增强" class="header-anchor">#</a> 原生类增强</h4> <p>There is no difference between native classes and regular classes in terms of enhancement definition and writing interceptors. However, it is desirable for plugin developers to minimize enhancement to native classes for three reasons:</p> <ul><li>Enhancements to native classes tend to be divergent. And enhancements to them are likely to impact other plugins or host functionality.</li> <li>The native class enhancement logic will use reflection to invoke interceptor methods in the system classloader. Due to the <em>Java</em> redefinition of the <em>Class</em>, every time an enhanced method is called, the reflection logic is processed, which significantly limits the performance of the method.</li> <li>The enhancements to the native classes involved using the <strong>Advice template class</strong> to generate a dynamic interceptor class. For each enhanced native class method, one will be generated dynamically and they will be loaded by the system classloader. If native classes are enhanced without restriction, loading dynamic classes can also become a significant burden during startup.</li></ul> <p>In summary, <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> provides the ability to augment <em>Java</em> native classes. However, it is not recommended to enhance them without restrictions. If there are multiple enhancement points to choose from, you'd better choose enhancing regular classes.</p> <h3 id="interceptor"><a href="#interceptor" class="header-anchor">#</a> Interceptor</h3> <p>Interceptors are used to define enhancement logic before and after bytecode enhancement of methods of the enhanced class, and when handling exceptions:</p> <ul><li><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/interceptor/Interceptor.java" target="_blank" rel="noopener noreferrer">interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: the interceptor interface, which contains three methods:
<ul><li><code>before</code>, the preceding method, which is executed before the interception point. The ExecuteContext parameter is the context of the plugin execution, which encapsulates all the parameters required for the interceptor to operate. Through the skip method, the main process can be skipped and the final method result can be set. Note that the main process cannot be skipped when the constructor is enhanced .</li> <li><code>after</code>, the post-method, ends up in the post-method whether or not the intercepted method executes normally. Postmethods can override the return value of the intercepted method with their return value, so developers need to be careful not to return null easily here.</li> <li><code>onThrow</code>, an exception handling method that is triggered when the intercepted method executes an exception. Handling the exception here does not affect the normal throwing of the exception.</li></ul></li></ul> <h2 id="plugin-configuration"><a href="#plugin-configuration" class="header-anchor">#</a> Plugin Configuration</h2> <p>Defining the plugin configuration starts with defining a plugin configuration class for the plugin, which needs to inherite<a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/config/PluginConfig.java" target="_blank" rel="noopener noreferrer">PluginConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，uses <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/common/ConfigTypeKey.java" target="_blank" rel="noopener noreferrer">ConfigTypeKey<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to decorate, specifies the prefix of the configuration that the configuration class can read, use <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/common/ConfigFieldKey.java" target="_blank" rel="noopener noreferrer">ConfigFieldKey<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>to decorate the fields of this class(if not decorated, read a configuration whose read configuration name is the same as that of the variable), specifying the configuration name of the configuration corresponding to that variable.</p> <p>Create a config.yaml file in the plugin's <code>config</code> directory:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">demo.config</span><span class="token punctuation">:</span>
  <span class="token key atrule">demo-config-A</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">demoConfigB</span><span class="token punctuation">:</span> 127.0.0.1
</code></pre></div><p>Corresponding configuration classes:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigTypeKey</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;demo.config&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoConfig</span> <span class="token keyword">implements</span> <span class="token class-name">PluginConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@ConfigFieldKey</span><span class="token punctuation">(</span><span class="token string">&quot;demo-config-A&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> demoConfigA<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> demoConfigB<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, don't forget to add the <em>SPI</em> configuration file for the plugin configuration:</p> <ul><li>Add <code>META-INF/services</code> folder under <code>resources</code>.</li> <li>Add <code>com.huaweicloud.sermant.core.plugin.config.PluginConfig</code> configuration file under <code>META-INF/services</code>.</li> <li>In the above file, type the <code>PluginConfig</code> implementation for all plugin configurations in the plugin package and separate them by LF.</li></ul> <p>How to use configuration in plugin. The <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/config/PluginConfigManager.java" target="_blank" rel="noopener noreferrer">PluginConfigManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> provides the interface to obtain the plugin configuration <code>PluginConfig</code>. In the plugin, you can obtain an instance of the plugin configuration through this manager and use it. The method of obtaining the instance is as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${plugin config class} is the plugin configuration class</span>
<span class="token class-name">PluginConfigManager</span><span class="token punctuation">.</span><span class="token function">getPluginConfig</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>plugin config <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>PluginConfigManager</code> is the unified configuration manager <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/ConfigManager.java" target="_blank" rel="noopener noreferrer">ConfigManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, The plugin side can directly use the interface of the latter to obtain plugin configuration and unified configuration：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${base config class}is the plugin configuration class or unified configuration class</span>
<span class="token class-name">ConfigManager</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>base config <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Configuration now supports data types include:</p> <ul><li>Primitive and wrapper types for Boolean and numeric classes</li> <li>String</li> <li>Enum</li> <li>Complex object</li> <li>Array of the above types</li> <li>List of the first four types</li> <li>Map of the first four types</li></ul> <p><em>YAML</em> format configuration files currently have a few other rules:</p> <ul><li>For complex objects involved in arrays, lists, and maps, using <code>ConfigFieldKey</code> to fix property names is not supported.</li> <li>For strings in arrays, lists, and maps, there is no support for <code>${}</code> conversions, <strong>plugin configuration class</strong> string properties and string properties inside complex type properties are supported.</li> <li>Parameters are only used for string <code>${}</code> conversions. Direct setting property values using parameters is not supported.</li> <li>The field names of configuration classes are usually small camels.You can use <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/common/ConfigTypeKey.java" target="_blank" rel="noopener noreferrer">ConfigFieldKey<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to define aliases for the transverse-line style. After the annotation is added, it can be parsed in <em>YAML</em> using either transverse-line or small camel style.</li> <li>The priority of the configuration is: startup parameters &gt; environment variables &gt; system variables (-d parameter) &gt; <em>YAML</em> file configuration</li> <li>When the attributes of the configuration class obtain reference values (startup parameter, environment variable, and system variable (-D parameter)) according to the priority of the effective value, the small hump and the hyphen can be split into words for searching and matching.</li> <li>If the key of the basic data type/array /map/list/set(which does not support complex objects) is not defined in the <em>YAML</em> configuration, the reference value will be obtained according to the priority of the configuration effect: startup parameters &gt; environment variables &gt; system variables (-d parameter). When retrieving reference values from the above data sources, note that:
<ul><li>The array /list/set should be configured in <code>YAML</code> string format. For example: DEMO_TEST_LIST_NAME=[elem1,elem2]</li> <li>The map needs to be configured as a <code>YAML</code> string format. For example: DEMO_TEST_MAP_NAME={key1: value1, key2: value2}</li></ul></li></ul> <h2 id="plugin-service"><a href="#plugin-service" class="header-anchor">#</a> Plugin Service</h2> <p><strong>Plugin Services</strong> are mainly divided into two parts:</p> <p><strong>Service interface definition</strong> is used to describe the capabilities provided by the service in <code>Plugin Main Module</code>,
when define the service interface, need to inherit<a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/service/PluginService.java" target="_blank" rel="noopener noreferrer">PluginService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>plugin service base interface, it provide <code>start()</code> will be called when <strong>Sermant</strong> start，<code>stop()</code> will be called when JVM stop.</p> <p><strong>Service interface implementation</strong> is in <code>Plugin Service Module</code>，in <code>Plugin Main Module</code> you can get and use the implementations by <em>SPI</em>.</p> <p>Finally, don't forget to add the <em>SPI</em> configuration file for the plugin service:</p> <ul><li>Add <code>META-INF/services</code> folder under <code>resources</code>.</li> <li>Add <code>com.huaweicloud.sermant.core.plugin.service.PluginService</code> configuration file under <code>META-INF/services</code>.</li> <li>In the above file, type the <code>PluginConfig</code> implementation for all plugin services in the <code>Plugin Service Module</code> package and separate them by LF.</li></ul> <p>In <code>Plugin Main Module</code> you can use <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/service/PluginServiceManager.java" target="_blank" rel="noopener noreferrer">PluginServiceManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to get <code>PluginService</code>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${plugin service class} is the plugin service class</span>
<span class="token class-name">PluginServiceManager</span><span class="token punctuation">.</span><span class="token function">getPluginService</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>plugin service <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>PluginServiceManager</code> is a particular case of <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/service/ServiceManager.java" target="_blank" rel="noopener noreferrer">ServiceManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The latter interface can be used directly to access the core and plugin services:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${base service class}is the core service class or plugin service class</span>
<span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>base service <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/23/2024, 9:29:29 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/versions/1.2.x/assets/js/app.4759eb35.js" defer></script><script src="/versions/1.2.x/assets/js/3.2e41a223.js" defer></script><script src="/versions/1.2.x/assets/js/1.b15421ba.js" defer></script><script src="/versions/1.2.x/assets/js/32.5c1bfb7d.js" defer></script>
  </body>
</html>
