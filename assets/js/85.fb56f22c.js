(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{532:function(t,s,a){"use strict";a.r(s);var e=a(26),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"xds服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xds服务"}},[t._v("#")]),t._v(" xDS服务")]),t._v(" "),s("p",[t._v("Istio 的部署分为控制平面和数据平面。传统的数据平面通常使用带有网络代理的 Sidecar 容器（如 Envoy），这会增加微服务调用的网络延时。在 Kubernetes 场景下，Sermant 基于 xDS 协议直接与 Istiod 通信，实现了服务发现功能。使用基于 "),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-xds.html"}},[t._v("Istio+Sermant 的无代理服务网格")]),t._v("，可以显著降低微服务调用延时，并简化系统部署。本文介绍在开发中插件如何使用Sermant提供的xDS服务。")],1),t._v(" "),s("h2",{attrs:{id:"基于xds协议的服务发现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于xds协议的服务发现"}},[t._v("#")]),t._v(" 基于xDS协议的服务发现")]),t._v(" "),s("h3",{attrs:{id:"功能介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#功能介绍"}},[t._v("#")]),t._v(" 功能介绍")]),t._v(" "),s("p",[s("strong",[t._v("基于xDS协议的服务发现")]),t._v("允许Sermant对接Istio的控制平面获取Kubernetes Service信息和其对应的具体服务实例信息。")]),t._v(" "),s("blockquote",[s("p",[t._v("说明：使用Sermant的xDS服务发现能力需服务部署在Kubernetes容器环境并运行Istio。")])]),t._v(" "),s("h3",{attrs:{id:"开发示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发示例"}},[t._v("#")]),t._v(" 开发示例")]),t._v(" "),s("p",[t._v("本开发示例基于"),s("RouterLink",{attrs:{to:"/zh/document/developer-guide/"}},[t._v("创建首个插件")]),t._v("文档中创建的工程，演示插件如何通过Sermant框架提供的xDS服务发现能力获取服务实例：")],1),t._v(" "),s("ol",[s("li",[s("p",[t._v("在工程中"),s("code",[t._v("template/template-plugin")]),t._v("下的"),s("code",[t._v("io.sermant.template.TemplateDeclarer")]),t._v(" 类中新增变量"),s("code",[t._v("xdsServiceDiscovery")]),t._v("获取Sermant框架提供的xDS服务发现服务，用于获取服务实例：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsServiceDiscovery")]),t._v(" xdsServiceDiscovery "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsCoreService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXdsServiceDiscovery")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("获取服务发现实例之后，可以调用"),s("code",[t._v("XdsServiceDiscovery")]),t._v("提供的API进行相应的动作。本示例以服务实例的直接获取为例，获取名称为"),s("code",[t._v("service-test")]),t._v("的服务实例信息，可通过如下代码来实现：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExecuteContext")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("before")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExecuteContext")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" serviceInstance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" xdsServiceDiscovery"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Iterator")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" iterator "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" serviceInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("iterator")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("iterator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hasNext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceInstance")]),t._v(" instance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" iterator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ServiceInstance: ["')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getHost")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('" : "')]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"]"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("说明："),s("code",[t._v("service-test")]),t._v("必须是Kubernetes Service的名称，获取的服务实例信息为该Service对应的Pod实例数据，示例Kubernetes Service如下所示：")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: service-test\nspec:\n  type: ClusterIP\n  ports:\n  - name: http\n  \tport: 8080\n    targetPort: 8080\n    protocol: TCP\n  selector:\n    app: service-test\n")])])]),s("p",[t._v("开发完成后，可参照创建首个插件时的"),s("RouterLink",{attrs:{to:"/zh/document/developer-guide/#打包构建"}},[t._v("打包构建")]),t._v("流程，在工程根目录下执行 "),s("strong",[t._v("mvn package")]),t._v("后生成构建产物。")],1)]),t._v(" "),s("li",[s("p",[t._v("开启xDS服务并且在"),s("code",[t._v("agent/config/config.properties")]),t._v("中设置开启xDS服务，配置示例如下：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# xDS service switch\nagent.service.xds.service.enable=true\n")])])])]),t._v(" "),s("li",[s("p",[t._v("执行完成后打包Sermant镜像和宿主微服务镜像。在k8s环境中启动名称为"),s("code",[t._v("service-test")]),t._v("的Service，并创建相应的服务实例（用户自行实现）。最后在Kubernetes启动宿主应用并挂载Sermant。Kubernetes环境打包Sermant和宿主镜像以及宿主微服务挂载Sermant启动的指导请参考"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-injector.html#启动和结果验证"}},[t._v("Sermant Injector使用手册")])],1)]),t._v(" "),s("li",[s("p",[t._v("宿主微服务挂载Sermant的Pod启动成功后，可以执行以下命令获取宿主微服务日志，查看通过xDS服务发现能力获取的服务实例")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl logs "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${POD_NAME}")]),t._v("\nServiceInstance: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("xxx.xxx.xxx.xxx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" xxxx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("说明："),s("code",[t._v("${POD_NAME}")]),t._v("必须是宿主微服务运行的pod名称，可通过"),s("code",[t._v("kubectl get pod")]),t._v("命令查看。")])])])]),t._v(" "),s("h3",{attrs:{id:"xds服务发现api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xds服务发现api"}},[t._v("#")]),t._v(" xDS服务发现API")]),t._v(" "),s("p",[s("strong",[t._v("获取xDS服务发现服务：")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsServiceDiscovery")]),t._v(" xdsServiceDiscovery "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsCoreService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXdsServiceDiscovery")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("strong",[t._v("xDS服务发现")]),t._v("服务共有三个接口方法，分别用于直接获取服务实例、通过订阅方式获取服务实例和通过Cluster获取服务实例：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" serviceName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscribeServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" serviceName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsServiceDiscoveryListener")]),t._v(" listener"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Optional")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsClusterLoadAssigment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getClusterServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" clusterName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"直接获取服务实例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#直接获取服务实例"}},[t._v("#")]),t._v(" 直接获取服务实例")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("获取Kubernetes service的服务实例信息，返回值为"),s("code",[t._v("java.util.Set")]),t._v("类型，包含该service的所有服务实例")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("xdsServiceDiscovery"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])]),t._v(" "),s("h4",{attrs:{id:"订阅方式获取服务实例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#订阅方式获取服务实例"}},[t._v("#")]),t._v(" 订阅方式获取服务实例")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("订阅Kubernetes service的服务实例信息，并注册服务发现监听器，监听器的"),s("code",[t._v("process")]),t._v("函数可在监听到服务实例发生变化后执行自定义操作")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("xdsServiceDiscovery"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscribeServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsServiceDiscoveryListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("process")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("服务发现监听器"),s("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/service/xds/listener/XdsServiceDiscoveryListener.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("XdsServiceDiscoveryListener"),s("OutboundLink")],1),t._v("，其中包含的接口方法如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("方法")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("void process(Set"),s("ServiceInstance",[t._v(" instances)")])],1),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("处理最新服务实例信息的回调接口")])])])])]),t._v(" "),s("li",[s("p",[t._v("服务实例"),s("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/service/xds/entity/ServiceInstance.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("ServiceInstance"),s("OutboundLink")],1),t._v("，其方法如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("方法名")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("返回值类型")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("getClusterName()")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("String")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("获取服务实例所属的istio cluster名称")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("getServiceName()")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("String")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("获取服务实例所属的Kubernetes service名称")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("getHost()")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("String")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("获取服务实例的Pod IP")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("getPort()")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("int")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("获取服务实例的端口")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("getMetaData()")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("Map<String, String>")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("获取服务实例的元数据")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("isHealthy()")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("boolean")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("服务是否健康")])])])])])]),t._v(" "),s("h4",{attrs:{id:"通过cluster获取服务实例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过cluster获取服务实例"}},[t._v("#")]),t._v(" 通过Cluster获取服务实例")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("获取Service Cluster的服务实例信息，返回值为"),s("code",[t._v("Optional<XdsClusterLoadAssigment>")]),t._v("类型，包含该Cluster的所有服务实例：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("xdsServiceDiscovery"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getClusterServiceInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"outbound|8080||service-test.default.svc.cluster.local"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("Cluster服务实例"),s("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/service/xds/entity/XdsClusterLoadAssigment.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("XdsClusterLoadAssigment"),s("OutboundLink")],1),t._v("，其字段如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("字段名称")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("字段类型")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("serviceName")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("String")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("Cluster服务实例所属的服务名称")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("clusterName")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("String")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("Cluster名称")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("localityInstances")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("Map<XdsLocality, Set"),s("ServiceInstance",[t._v(">")])],1),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("Cluster的服务实例，由不同区域的服务实例组成")])])])])]),t._v(" "),s("li",[s("p",[t._v("区域信息"),s("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/service/xds/entity/XdsLocality.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("XdsLocality"),s("OutboundLink")],1),t._v("，其字段如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("字段名称")]),t._v(" "),s("th",[t._v("字段类型")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("region")]),t._v(" "),s("td",[t._v("String")]),t._v(" "),s("td",[t._v("区域信息")])]),t._v(" "),s("tr",[s("td",[t._v("zone")]),t._v(" "),s("td",[t._v("String")]),t._v(" "),s("td",[t._v("区域信息")])]),t._v(" "),s("tr",[s("td",[t._v("subZone")]),t._v(" "),s("td",[t._v("String")]),t._v(" "),s("td",[t._v("区域信息")])]),t._v(" "),s("tr",[s("td",[t._v("loadBalanceWeight")]),t._v(" "),s("td",[t._v("int")]),t._v(" "),s("td",[t._v("负载均衡权重")])]),t._v(" "),s("tr",[s("td",[t._v("localityPriority")]),t._v(" "),s("td",[t._v("int")]),t._v(" "),s("td",[t._v("区域优先级")])])])])])]),t._v(" "),s("h2",{attrs:{id:"基于xds协议的路由配置服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于xds协议的路由配置服务"}},[t._v("#")]),t._v(" 基于xDS协议的路由配置服务")]),t._v(" "),s("h3",{attrs:{id:"功能介绍-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#功能介绍-2"}},[t._v("#")]),t._v(" 功能介绍")]),t._v(" "),s("p",[s("strong",[t._v("基于xDS协议的路由配置")]),t._v("服务允许Sermant对接Istio的控制平面获取Kubernetes Service的路由配置信息。")]),t._v(" "),s("blockquote",[s("p",[t._v("说明：使用Sermant的xDS路由配置服务能力需服务部署在Kubernetes容器环境并运行Istio。")])]),t._v(" "),s("h3",{attrs:{id:"开发示例-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发示例-2"}},[t._v("#")]),t._v(" 开发示例")]),t._v(" "),s("p",[t._v("本开发示例基于"),s("RouterLink",{attrs:{to:"/zh/document/developer-guide/"}},[t._v("创建首个插件")]),t._v("文档中创建的工程，演示插件如何通过Sermant框架提供的xDS路由配置服务获取服务的路由配置信息：")],1),t._v(" "),s("ol",[s("li",[s("p",[t._v("在工程中"),s("code",[t._v("template/template-plugin")]),t._v("下的"),s("code",[t._v("io.sermant.template.TemplateDeclarer")]),t._v(" 类中新增变量"),s("code",[t._v("xdsRouteService")]),t._v("获取Sermant框架提供的xDS路由配置服务，用于获取服务的路由配置信息：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsRouteService")]),t._v(" xdsRouteService "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsCoreService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXdsRouteService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("获取路由配置服务实例之后，可以调用"),s("code",[t._v("xdsRouteService")]),t._v("提供的API调用指定服务的路由配置信息：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" serviceRoute "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" xdsRouteService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServiceRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"spring-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"The size of routing config: "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" serviceRoute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("说明："),s("code",[t._v("service-test")]),t._v("必须是Kubernetes Service的名称，获取的路由配置通过Istio提供的"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/",target:"_blank",rel:"noopener noreferrer"}},[t._v("DestinationRule"),s("OutboundLink")],1),t._v("和"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/",target:"_blank",rel:"noopener noreferrer"}},[t._v("VirtualService"),s("OutboundLink")],1),t._v("下发，Sermant具体支持的路由配置字段和配置模版请参考"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-xds.html#基于xDS服务的路由能力"}},[t._v("基于xDS服务的路由能力")]),t._v("一节。")],1)]),t._v(" "),s("p",[t._v("开发完成后，可参照创建首个插件时的"),s("RouterLink",{attrs:{to:"/zh/document/developer-guide/#打包构建"}},[t._v("打包构建")]),t._v("流程，在工程根目录下执行 "),s("strong",[t._v("mvn package")]),t._v("后生成构建产物。")],1)]),t._v(" "),s("li",[s("p",[t._v("开启xDS服务并且在"),s("code",[t._v("agent/config/config.properties")]),t._v("中设置开启xDS服务，配置示例如下：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# xDS service switch\nagent.service.xds.service.enable=true\n")])])])]),t._v(" "),s("li",[s("p",[t._v("执行完成后打包Sermant镜像和宿主微服务镜像。在Kubernetes启动宿主应用并挂载Sermant。Kubernetes环境打包Sermant和宿主镜像以及宿主微服务挂载Sermant启动的指导请参考"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-injector.html#启动和结果验证"}},[t._v("Sermant Injector使用手册")]),t._v("。根据Sermant提供的"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-xds.html#Istio路由配置模版"}},[t._v("路由配置模版")]),t._v("下发"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/",target:"_blank",rel:"noopener noreferrer"}},[t._v("DestinationRule"),s("OutboundLink")],1),t._v("和"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/reference/config/networking/virtual-service/",target:"_blank",rel:"noopener noreferrer"}},[t._v("VirtualService"),s("OutboundLink")],1),t._v("规则。")],1)]),t._v(" "),s("li",[s("p",[t._v("宿主微服务挂载Sermant的Pod启动成功后，可以执行以下命令获取宿主微服务日志，查看通过xDS路由配置服务获取的路由配置数量")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl logs "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${POD_NAME}")]),t._v("\nThe size of routing config: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("说明："),s("code",[t._v("${POD_NAME}")]),t._v("必须是宿主微服务运行的pod名称，可通过"),s("code",[t._v("kubectl get pod")]),t._v("命令查看。")])])])]),t._v(" "),s("h3",{attrs:{id:"xds路由配置服务api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xds路由配置服务api"}},[t._v("#")]),t._v(" xDS路由配置服务API")]),t._v(" "),s("p",[s("strong",[t._v("获取xDS路由配置服务：")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsRouteService")]),t._v(" xdsRouteService "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsCoreService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getXdsRouteService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("strong",[t._v("xDS路由配置服务")]),t._v("服务共有两个接口方法，分别用于获取Service的路由配置信息、Cluster是否开启同AZ路由：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServiceRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" serviceName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isLocalityRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" clusterName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"获取服务的路由配置信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#获取服务的路由配置信息"}},[t._v("#")]),t._v(" 获取服务的路由配置信息")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("获取Kubernetes Service的路由配置信息，返回值为"),s("code",[t._v("List<XdsRoute>")]),t._v("类型，包含该Service的所有路由配置信息")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("xdsRouteService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getServiceRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("路由配置"),s("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/service/xds/entity/XdsRoute.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("XdsRoute"),s("OutboundLink")],1),t._v("，其字段如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("字段名称")]),t._v(" "),s("th",[t._v("字段类型")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("name")]),t._v(" "),s("td",[t._v("String")]),t._v(" "),s("td",[t._v("路由配置的名称")])]),t._v(" "),s("tr",[s("td",[t._v("routeMatch")]),t._v(" "),s("td",[t._v("XdsRouteMatch")]),t._v(" "),s("td",[t._v("路由匹配的匹配规则")])]),t._v(" "),s("tr",[s("td",[t._v("routeAction")]),t._v(" "),s("td",[t._v("XdsRouteAction")]),t._v(" "),s("td",[t._v("路由匹配的路由目的地")])])])])])]),t._v(" "),s("h4",{attrs:{id:"clusteraz路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#clusteraz路由"}},[t._v("#")]),t._v(" ClusterAZ路由")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("获取Service的Cluster是否开启同AZ路由，返回值为"),s("code",[t._v("boolean")]),t._v("类型")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("xdsRouteService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isLocalityRoute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"outbound|8080||service-test.default.svc.cluster.local"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("；\n")])])])])]),t._v(" "),s("h2",{attrs:{id:"基于xds协议的负载均衡配置服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于xds协议的负载均衡配置服务"}},[t._v("#")]),t._v(" 基于xDS协议的负载均衡配置服务")]),t._v(" "),s("h3",{attrs:{id:"功能介绍-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#功能介绍-3"}},[t._v("#")]),t._v(" 功能介绍")]),t._v(" "),s("p",[s("strong",[t._v("基于xDS协议的负载均衡配置服务")]),t._v("允许Sermant对接Istio的控制平面获取Kubernetes Service的负载均衡规则。")]),t._v(" "),s("blockquote",[s("p",[t._v("说明：使用Sermant的xDS负载均衡配置服务需服务部署在Kubernetes容器环境并运行Istio。")])]),t._v(" "),s("h3",{attrs:{id:"开发示例-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发示例-3"}},[t._v("#")]),t._v(" 开发示例")]),t._v(" "),s("p",[t._v("本开发示例基于"),s("RouterLink",{attrs:{to:"/zh/document/developer-guide/"}},[t._v("创建首个插件")]),t._v("文档中创建的工程，演示插件如何通过Sermant框架提供的xDS负载均衡配置服务获取服务的负载均衡规则：")],1),t._v(" "),s("ol",[s("li",[s("p",[t._v("在工程中"),s("code",[t._v("template/template-plugin")]),t._v("下的"),s("code",[t._v("io.sermant.template.TemplateDeclarer")]),t._v(" 类中新增变量"),s("code",[t._v("loadBalanceService")]),t._v("获取Sermant框架提供的xDS负载均衡配置服务，用于获取服务的负载均衡规则：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsLoadBalanceService")]),t._v(" loadBalanceService "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsCoreService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLoadBalanceService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("获取负载均衡配置服务之后，可以调用"),s("code",[t._v("loadBalanceService")]),t._v("提供的API获取服务的负载均衡策略：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsLbPolicy")]),t._v(" serviceLbPolicy "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" loadBalanceService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBaseLbPolicyOfService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"spring-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service lb policy: "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" serviceLbPolicy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("说明："),s("code",[t._v("service-test")]),t._v("必须是Kubernetes Service的名称，获取的负载均衡配置通过Istio提供的"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/",target:"_blank",rel:"noopener noreferrer"}},[t._v("DestinationRule"),s("OutboundLink")],1),t._v("下发，Sermant具体支持的负载均配置字段、支持配置的负载均衡规则和配置模版请参考"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-xds.html#基于xDS服务的负载均衡能力"}},[t._v("基于xDS服务的负载均衡能力")]),t._v("一节。")],1)]),t._v(" "),s("p",[t._v("开发完成后，可参照创建首个插件时的"),s("RouterLink",{attrs:{to:"/zh/document/developer-guide/#打包构建"}},[t._v("打包构建")]),t._v("流程，在工程根目录下执行 "),s("strong",[t._v("mvn package")]),t._v("后生成构建产物。")],1)]),t._v(" "),s("li",[s("p",[t._v("开启xDS服务并且在"),s("code",[t._v("agent/config/config.properties")]),t._v("中设置开启xDS服务，配置示例如下：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# xDS service switch\nagent.service.xds.service.enable=true\n")])])])]),t._v(" "),s("li",[s("p",[t._v("执行完成后打包Sermant镜像和宿主微服务镜像。在Kubernetes启动宿主微服务并挂载Sermant。Kubernetes环境打包Sermant和宿主镜像以及宿主微服务挂载Sermant启动的指导请参考"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-injector.html#启动和结果验证"}},[t._v("Sermant Injector使用手册")]),t._v("。根据Sermant提供的"),s("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-xds.html#Istio负载均衡配置模版"}},[t._v("负载均衡配置模版")]),t._v("下发"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/",target:"_blank",rel:"noopener noreferrer"}},[t._v("DestinationRule"),s("OutboundLink")],1),t._v("。")],1)]),t._v(" "),s("li",[s("p",[t._v("宿主微服务挂载Sermant的Pod启动成功后，可以执行以下命令获取宿主微服务日志，查看通过xDS负载均衡配置服务获取的服务负载均衡策略")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl logs "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${POD_NAME}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" lb policy: ROUND_ROBIN\n")])])]),s("blockquote",[s("p",[t._v("说明："),s("code",[t._v("${POD_NAME}")]),t._v("必须是宿主微服务运行的pod名称，可通过"),s("code",[t._v("kubectl get pod")]),t._v("命令查看。")])])])]),t._v(" "),s("h3",{attrs:{id:"xds负载均衡配置服务api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xds负载均衡配置服务api"}},[t._v("#")]),t._v(" xDS负载均衡配置服务API")]),t._v(" "),s("p",[s("strong",[t._v("获取xDS负载均衡配置服务：")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsLoadBalanceService")]),t._v(" loadBalanceService "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServiceManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsCoreService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLoadBalanceService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("strong",[t._v("xDS负载均衡配置服务")]),t._v("共有两个接口方法，分别用于获取Service的负载均衡规则、Cluster的负载均衡规则：")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsLbPolicy")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLbPolicyOfCluster")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" clusterName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XdsLbPolicy")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBaseLbPolicyOfService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" serviceName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"获取service的负载均衡规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#获取service的负载均衡规则"}},[t._v("#")]),t._v(" 获取Service的负载均衡规则")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("获取Service的负载均衡规则，返回值为"),s("code",[t._v("XdsLbPolicy")]),t._v("类型")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("loadBalanceService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBaseLbPolicyOfService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service-test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("；\n")])])])]),t._v(" "),s("li",[s("p",[t._v("负载均衡规则实体类"),s("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/io/sermant/core/service/xds/entity/XdsLbPolicy.java",target:"_blank",rel:"noopener noreferrer"}},[t._v("XdsLbPolicy"),s("OutboundLink")],1),t._v("为枚举类型")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("负载均衡规则")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("XdsLbPolicy.RANDOM")]),t._v(" "),s("td",[t._v("随机负载均衡规则")])]),t._v(" "),s("tr",[s("td",[t._v("XdsLbPolicy.ROUND_ROBIN")]),t._v(" "),s("td",[t._v("轮训负载均衡规则")])]),t._v(" "),s("tr",[s("td",[t._v("XdsLbPolicy.LEAST_REQUEST")]),t._v(" "),s("td",[t._v("最小请求负载均衡规则")])]),t._v(" "),s("tr",[s("td",[t._v("XdsLbPolicy.UNRECOGNIZED")]),t._v(" "),s("td",[t._v("未识别的负载均衡规则")])])])])])]),t._v(" "),s("h4",{attrs:{id:"获取cluster的负载均衡规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#获取cluster的负载均衡规则"}},[t._v("#")]),t._v(" 获取Cluster的负载均衡规则")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("获取Service Cluster的负载均衡规则，返回值为"),s("code",[t._v("XdsLbPolicy")]),t._v("类型")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("loadBalanceService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLbPolicyOfCluster")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"outbound|8080||service-test.default.svc.cluster.local"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("；\n")])])])])]),t._v(" "),s("h2",{attrs:{id:"xds服务配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xds服务配置"}},[t._v("#")]),t._v(" xDS服务配置")]),t._v(" "),s("p",[t._v("在Sermant Agent的产品包"),s("code",[t._v("agent/config/config.properties")]),t._v("，可通过"),s("code",[t._v("agent.service.xds.service.enable")]),t._v("配置项开启xDS服务，xDS服务的其他配置也在该文件进行配置：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# xDS服务开关\nagent.service.xds.service.enable=false\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);