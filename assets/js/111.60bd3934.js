(window.webpackJsonp=window.webpackJsonp||[]).push([[111],{560:function(t,e,a){"use strict";a.r(e);var s=a(26),n=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"sermant-injector使用手册"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sermant-injector使用手册"}},[t._v("#")]),t._v(" Sermant Injector使用手册")]),t._v(" "),e("p",[t._v("Sermant Injector是基于Kubernetes准入控制器（Admission Controllers）特性开发而来。准入控制器位于k8s API Server中，能够拦截对API Server的请求，完成身份验证、授权、变更等操作。本文介绍在k8s环境下，如何通过Sermant Injector组件来实现宿主应用自动挂载Sermant Agent包的快速部署。")]),t._v(" "),e("p",[t._v("Sermant Injector属于变更准入控制器(MutatingAdmissionWebhook), 能够在创建容器资源前对请求进行拦截和修改。Sermant Injector部署在k8s后，只需在宿主应用部署的YAML文件中"),e("code",[t._v("spec > template > metadata> labels")]),t._v("层级加入"),e("code",[t._v("sermant-injection: enabled")]),t._v("即可实现自动挂载Sermant Agent。另外，Sermant Injector还支持通过"),e("code",[t._v("annotations")]),t._v("的方式配置环境变量。部署应用自动挂载Sermant并通过"),e("code",[t._v("annotations")]),t._v("配置环境变量的使用方式可参考下文"),e("a",{attrs:{href:"#%E9%83%A8%E7%BD%B2%E5%AE%BF%E4%B8%BB%E5%BA%94%E7%94%A8"}},[t._v("部署宿主应用")]),t._v("中的描述。")]),t._v(" "),e("h2",{attrs:{id:"参数配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参数配置"}},[t._v("#")]),t._v(" 参数配置")]),t._v(" "),e("h3",{attrs:{id:"sermant-injector的参数配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sermant-injector的参数配置"}},[t._v("#")]),t._v(" Sermant Injector的参数配置")]),t._v(" "),e("p",[t._v("本项目采用Helm进行Kubernetes包管理, 部署Sermant Injector相关参数需在"),e("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-injector/deployment/release/injector/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[t._v("sermant-injector/deployment/release/values.yaml"),e("OutboundLink")],1),t._v("中做修改配置。")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("injector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pullPolicy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pullSecrets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("secret\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("agent")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pullPolicy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ZOOKEEPER\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//localhost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30110")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("registry")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//localhost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30100")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configMap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])]),e("p",[t._v("参数说明如下：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("span",{staticStyle:{display:"inline-block",width:"100px"}},[t._v("主参数键")])]),t._v(" "),e("th",[e("span",{staticStyle:{display:"inline-block",width:"100px"}},[t._v("二层参数键")])]),t._v(" "),e("th",[e("span",{staticStyle:{display:"inline-block",width:"100px"}},[t._v("三层参数键")])]),t._v(" "),e("th",[t._v("说明")]),t._v(" "),e("th",[e("span",{staticStyle:{display:"inline-block",width:"40px"}},[t._v("是否必须")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("namespace")]),t._v(" "),e("td",[t._v("name")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("部署Sermant Injector所在的namespace")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("injector")]),t._v(" "),e("td",[t._v("replicas")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("部署Sermant Injector的实例个数")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("image")]),t._v(" "),e("td",[t._v("addr")]),t._v(" "),e("td",[t._v("Sermant Injector的镜像地址")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("pullPolicy")]),t._v(" "),e("td",[t._v("Sermant Injector的镜像拉取策略：Always(总是拉取)，IfNotPresent(默认值,本地有则使用本地镜像,不拉取)，Never(只使用本地镜像，从不拉取)")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("pullSecrets")]),t._v(" "),e("td",[t._v("拉取镜像的密钥，默认为default-secret，按需修改")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("agent")]),t._v(" "),e("td",[t._v("image")]),t._v(" "),e("td",[t._v("addr")]),t._v(" "),e("td",[t._v("Sermant Agent的镜像地址")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("pullPolicy")]),t._v(" "),e("td",[t._v("Sermant Agent的镜像拉取策略：Always(总是拉取)，IfNotPresent(默认值,本地有则使用本地镜像,不拉取)，Never(只使用本地镜像，从不拉取)")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("config")]),t._v(" "),e("td",[t._v("type")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Sermant Agent配置中心类型: 当前支持ZooKeeper、Kie和Nacos")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("endpoints")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Sermant Agent配置中心地址")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("registry")]),t._v(" "),e("td",[t._v("endpoints")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Sermant Agent注册插件的注册中心地址")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("configMap")]),t._v(" "),e("td",[t._v("enabled")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("通用环境变量配置开关，默认为false，如需开启请配置为true")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("namespaces")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("注入configMap的namespace，需与业务应用的namespace保持一致")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("env")]),t._v(" "),e("td",[t._v("自定义key1")]),t._v(" "),e("td",[t._v("配置自定义value1")]),t._v(" "),e("td",[t._v("否")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("自定义key2")]),t._v(" "),e("td",[t._v("配置自定义value2")]),t._v(" "),e("td",[t._v("否")])])])]),t._v(" "),e("p",[e("strong",[t._v("通用环境变量配置：")])]),t._v(" "),e("p",[t._v("Sermant Injector支持为宿主应用所在pod配置自定义的环境变量，方法为在"),e("code",[t._v("sermant-injector/deployment/release/injector/values.yaml")]),t._v("中修改"),e("code",[t._v("configMap.env")]),t._v("的内容，前提是"),e("code",[t._v("configMap.enabled")]),t._v("配置为"),e("code",[t._v("true")]),t._v("，并正确配置"),e("code",[t._v("configMap.namespaces")]),t._v("。通用环境变量的配置方式如下(kv形式)：")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configMap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  \t"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("TEST_ENV1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" abc\n  \t"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("TEST_ENV2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\n")])])]),e("p",[t._v("例如，在Sermant使用过程中，某些配置为当前k8s集群下各pod共享的公共配置，例如"),e("strong",[t._v("Backend")]),t._v("后端的ip和端口等。则可在此处配置：")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configMap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\t\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateway.nettyIp")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateway.nettyPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("6888")]),t._v("\n")])])]),e("p",[t._v("即可使default命名空间下的所有pod挂载的Sermant都与该"),e("strong",[t._v("Backend")]),t._v("后端连接。")]),t._v(" "),e("p",[e("strong",[t._v("注意")]),t._v("：此处"),e("code",[t._v("configMap")]),t._v("配置的环境变量优先级低于宿主应用yaml中"),e("code",[t._v("env")]),t._v("的优先级。由于"),e("code",[t._v("config.type")]),t._v(","),e("code",[t._v("config.endpoints")]),t._v("和"),e("code",[t._v("registry.endpoints")]),t._v("本质上是通过"),e("code",[t._v("env")]),t._v("的方式加载环境变量，因此优先级也高于"),e("code",[t._v("configMap")]),t._v("配置的相应的sermant的环境变量。")]),t._v(" "),e("h3",{attrs:{id:"镜像制作脚本的参数配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#镜像制作脚本的参数配置"}},[t._v("#")]),t._v(" 镜像制作脚本的参数配置")]),t._v(" "),e("p",[e("strong",[e("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-injector/images/sermant-agent/build-sermant-image.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("build-sermant-image.sh"),e("OutboundLink")],1)])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("参数名")]),t._v(" "),e("th",[t._v("说明")]),t._v(" "),e("th",[t._v("是否必须")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("sermantVersion")]),t._v(" "),e("td",[t._v("sermant-agent-x.x.x.tar.gz包的版本")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("imageName")]),t._v(" "),e("td",[t._v("构建的Sermant Agent镜像名称")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("imageVersion")]),t._v(" "),e("td",[t._v("构建的Sermant Agent镜像版本")]),t._v(" "),e("td",[t._v("是")])])])]),t._v(" "),e("p",[e("strong",[e("a",{attrs:{href:"https://github.com/sermant-io/Sermant/blob/develop/sermant-injector/images/injector/build-injector-image.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("build-injector-image.sh"),e("OutboundLink")],1)])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("参数名")]),t._v(" "),e("th",[t._v("说明")]),t._v(" "),e("th",[t._v("是否必须")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("imageName")]),t._v(" "),e("td",[t._v("构建的Sermant Injector镜像名称")]),t._v(" "),e("td",[t._v("是")])]),t._v(" "),e("tr",[e("td",[t._v("imageVersion")]),t._v(" "),e("td",[t._v("构建的Sermant Injector镜像版本")]),t._v(" "),e("td",[t._v("是")])])])]),t._v(" "),e("h2",{attrs:{id:"支持版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#支持版本"}},[t._v("#")]),t._v(" 支持版本")]),t._v(" "),e("p",[t._v("Sermant Injector当前支持在Kubernetes 1.15及以上版本进行部署，通过Helm v3版本来进行Kubernetes包管理。")]),t._v(" "),e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://kubernetes.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Kubernetes 1.15+"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://helm.sh/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Helm v3"),e("OutboundLink")],1)])])]),t._v(" "),e("h2",{attrs:{id:"启动和结果验证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动和结果验证"}},[t._v("#")]),t._v(" 启动和结果验证")]),t._v(" "),e("p",[t._v("在部署Sermant Injector前需要先构建Sermant Agent镜像以及Sermant Injector镜像。")]),t._v(" "),e("h3",{attrs:{id:"构建sermant-agent镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#构建sermant-agent镜像"}},[t._v("#")]),t._v(" 构建Sermant Agent镜像")]),t._v(" "),e("h4",{attrs:{id:"准备sermant-agent包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备sermant-agent包"}},[t._v("#")]),t._v(" 准备Sermant Agent包")]),t._v(" "),e("p",[t._v("点击 "),e("a",{attrs:{href:"https://github.com/sermant-io/Sermant/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v("下载release包，也可以在项目中自行打包。")]),t._v(" "),e("h4",{attrs:{id:"制作镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#制作镜像"}},[t._v("#")]),t._v(" 制作镜像")]),t._v(" "),e("p",[t._v("修改文件夹 "),e("code",[t._v("sermant-injector/images/sermant-agent")]),t._v("下"),e("code",[t._v("build-sermant-image.sh")]),t._v(" 脚本中"),e("code",[t._v("sermantVersion")]),t._v(","),e("code",[t._v("imageName")]),t._v("和"),e("code",[t._v("imageVerison")]),t._v("的值。")]),t._v(" "),e("p",[t._v("在k8s节点下，将"),e("code",[t._v("build-sermant-image.sh")]),t._v("和"),e("code",[t._v("Sermant.Dockerfile")]),t._v("置于release包"),e("code",[t._v("sermant-agent-xxx.tar.gz")]),t._v("同一目录下，执行"),e("code",[t._v("build-sermant-image.sh")]),t._v("脚本，完成Sermant Agent镜像制作。")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" build-sermant-image.sh\n")])])]),e("p",[t._v("如需将镜像推送至镜像仓库，请执行"),e("code",[t._v("docker push ${imageName}:{imageVerison}")]),t._v(" 命令。")]),t._v(" "),e("h3",{attrs:{id:"构建sermant-injector镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#构建sermant-injector镜像"}},[t._v("#")]),t._v(" 构建Sermant Injector镜像")]),t._v(" "),e("h4",{attrs:{id:"准备sermant-injector包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备sermant-injector包"}},[t._v("#")]),t._v(" 准备Sermant Injector包")]),t._v(" "),e("p",[t._v("在Sermant Injector项目下执行"),e("code",[t._v("mvn clean package")]),t._v("命令，在项目目录下生成"),e("code",[t._v("sermant-injector.jar")]),t._v("文件")]),t._v(" "),e("h4",{attrs:{id:"制作镜像-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#制作镜像-2"}},[t._v("#")]),t._v(" 制作镜像")]),t._v(" "),e("p",[t._v("修改文件夹 "),e("code",[t._v("sermant-injector/images/injector")]),t._v("下"),e("code",[t._v("build-injector-image.sh")]),t._v(" 脚本中"),e("code",[t._v("imageName")]),t._v("和"),e("code",[t._v("imageVerison")]),t._v("的值：")]),t._v(" "),e("p",[t._v("在k8s节点下，将"),e("code",[t._v("build-injector-image.sh")]),t._v("、"),e("code",[t._v("start.sh")]),t._v("和"),e("code",[t._v("Injector.Dockerfile")]),t._v("置于Sermant Injector包"),e("code",[t._v("sermant-injector.jar")]),t._v("同一目录下，执行"),e("code",[t._v("build-injector-image.sh")]),t._v("脚本，完成Sermant Injector镜像制作。")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" build-injector-image.sh\n")])])]),e("p",[t._v("如需将镜像推送至镜像仓库，请执行"),e("code",[t._v("docker push ${imageName}:{imageVerison}")]),t._v(" 命令。")]),t._v(" "),e("h3",{attrs:{id:"部署sermant-injector实例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署sermant-injector实例"}},[t._v("#")]),t._v(" 部署Sermant Injector实例")]),t._v(" "),e("p",[t._v("在宿主应用容器化部署前，需要先部署Sermant Injector实例。本项目采用Helm进行Kubernetes包管理，使用"),e("code",[t._v("sermant-injector/deployment/release")]),t._v("下的"),e("code",[t._v("injector")]),t._v("Chart模版。")]),t._v(" "),e("p",[t._v("按实际环境修改"),e("code",[t._v("values.yaml")]),t._v("中的模版变量，修改完成后，执行"),e("code",[t._v("helm install")]),t._v("命令在k8s中部署Sermant Injector实例:")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("helm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" sermant-injector sermant-injector/deployment/release/injector\n")])])]),e("p",[t._v("检查Sermant Injector部署pod状态为running。")]),t._v(" "),e("p",[t._v("至此，宿主应用部署前的环境配置工作完成。")]),t._v(" "),e("h3",{attrs:{id:"部署宿主应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署宿主应用"}},[t._v("#")]),t._v(" 部署宿主应用")]),t._v(" "),e("p",[e("strong",[t._v("自动挂载Sermant")])]),t._v(" "),e("p",[t._v("在完成上述Sermant Injector部署后，用户根据实际应用编写yaml部署K8s Deployment资源，只需在"),e("code",[t._v("spec > template > metadata> labels")]),t._v("层级加入"),e("code",[t._v("sermant-injection: enabled")]),t._v("即可实现自动挂载Sermant Agent。(如后续不希望挂载，删除后重新启动应用即可)")]),t._v(" "),e("p",[e("strong",[t._v("通过annotations方式配置环境变量")])]),t._v(" "),e("p",[t._v("如果用户希望在Deployment中配置自定义环境变量，只需在"),e("code",[t._v("spec > template > metadata> annotations")]),t._v("层级添加相应的键值对即可。配置方式可参考下文示例。")]),t._v(" "),e("p",[t._v("以"),e("code",[t._v('env.sermant.io/key1: "value1"')]),t._v("为例，配置规则为："),e("code",[t._v("env.sermant.io/")]),t._v("为通过"),e("code",[t._v("annotations")]),t._v("配置环境变量的标准前缀，"),e("code",[t._v("key1")]),t._v("为用户按需配置的自定义环境变量名称，"),e("code",[t._v("value1")]),t._v("为用户按需配置的自定义环境变量值。")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sermant-injection")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" enabled\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("annotations")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env.sermant.io/key1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value1"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env.sermant.io/key2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value2"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 请替换成您的应用镜像")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.0.0\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n")])])]),e("p",[t._v("若pod无法创建，请检查Sermant Injector是否正确部署以及Sermant Agent镜像是否正确构建。")]),t._v(" "),e("h3",{attrs:{id:"验证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[t._v("#")]),t._v(" 验证")]),t._v(" "),e("p",[t._v("pod创建成功后，执行如下命令，其中"),e("code",[t._v("${pod_name}")]),t._v("为宿主应用的pod名称")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl get po/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${pod_name}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" yaml\n")])])]),e("ol",[e("li",[e("p",[t._v("查看上述命令输出内容"),e("code",[t._v("spec > containers > env")]),t._v("下是否包含环境变量：name为"),e("code",[t._v("JAVA_TOOL_OPTIONS")]),t._v("，value为 "),e("code",[t._v("-javaagent:/home/sermant-agent/agent/sermant-agent.jar=appName=default")]),t._v("。")])]),t._v(" "),e("li",[e("p",[t._v("查看上述命令输出内容"),e("code",[t._v("spec > containers > initContainers > image")]),t._v(" 的值是否为构建Sermant Agent镜像时的镜像地址。")])])]),t._v(" "),e("p",[t._v("执行如下命令，其中"),e("code",[t._v("${pod_name}")]),t._v("为用户应用的pod名称，"),e("code",[t._v("${namespace}")]),t._v("为用户部署应用的namespace名称")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl logs "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${pod_name}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${namespace}")]),t._v("\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("查看上述命令输出内容pod日志开头部分是否包含：")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[INFO] Loading sermant agent...\n")])])]),e("p",[t._v("如果上述信息无误，则表明Sermant Agent已成功挂载至用户应用中。")])])}),[],!1,null,null,null);e.default=n.exports}}]);